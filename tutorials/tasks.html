<!DOCTYPE html><html><head><meta charSet="utf-8"/><link rel="apple-touch-icon" sizes="57x57" href="/static/images/icons/apple-icon-57x57.png"/><link rel="apple-touch-icon" sizes="60x60" href="/static/images/icons/apple-icon-60x60.png"/><link rel="apple-touch-icon" sizes="72x72" href="/static/images/icons/apple-icon-72x72.png"/><link rel="apple-touch-icon" sizes="76x76" href="/static/images/icons/apple-icon-76x76.png"/><link rel="apple-touch-icon" sizes="114x114" href="/static/images/icons/apple-icon-114x114.png"/><link rel="apple-touch-icon" sizes="120x120" href="/static/images/icons/apple-icon-120x120.png"/><link rel="apple-touch-icon" sizes="144x144" href="/static/images/icons/apple-icon-144x144.png"/><link rel="apple-touch-icon" sizes="152x152" href="/static/images/icons/apple-icon-152x152.png"/><link rel="apple-touch-icon" sizes="180x180" href="/static/images/icons/apple-icon-180x180.png"/><link rel="icon" type="image/png" sizes="192x192" href="/static/images/icons/android-icon-192x192.png"/><link rel="icon" type="image/png" sizes="32x32" href="/static/images/icons/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="96x96" href="/static/images/icons/favicon-96x96.png"/><link rel="icon" type="image/png" sizes="16x16" href="/static/images/icons/favicon-16x16.png"/><meta name="viewport" content="width=device-width"/><link rel="stylesheet" type="text/css" href="/static/css/bootstrap.min.css"/><link rel="stylesheet" type="text/css" href="/static/css/bebasNeue.css"/><link rel="stylesheet" type="text/css" href="/static/css/animations.css"/><link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,700,800|Roboto:100,300,400,500,700,900" rel="stylesheet"/><title>Actionhero</title><script src="/static/js/googleAnalytics.js"></script><meta name="next-head-count" content="21"/><link rel="preload" href="/_next/static/LBfMmkKIbhjxYUodTJOk3/pages/tutorials/%5Bname%5D.js" as="script"/><link rel="preload" href="/_next/static/LBfMmkKIbhjxYUodTJOk3/pages/_app.js" as="script"/><link rel="preload" href="/_next/static/runtime/webpack-08f7b238829422e3b9b2.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.205aac1996ebb87d3a48.js" as="script"/><link rel="preload" href="/_next/static/runtime/main-2325b25da04a50e601b5.js" as="script"/></head><body><div id="__next"><div><div style="padding-left:0;padding-right:0;font-family:Roboto, sans-serif;font-size:14px;font-weight:300" class="container-fluid"><header style="background-color:#2F5266"><div class="container"><nav style="background-color:#2F5266;padding-top:5px;margin-bottom:10px;border:0" class="navbar navbar-default"><div class="container"><div class="navbar-header"><a style="padding-top:0;margin-bottom:15px" class="navbar-brand"><img src="/static/images/actionhero-logo-header-wordmark.svg" style="padding-top:14px;padding-bottom:20px"/></a><button type="button" class="navbar-toggle collapsed"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button></div><div class="navbar-collapse collapse"><ul class="nav navbar-nav navbar-right"></ul><ul class="hidden-md hidden-sm hidden-xs nav navbar-nav navbar-left"><li role="presentation" class=""><a role="button" href="#"> </a></li><li role="presentation" class=""><a role="button" href="#"> </a></li></ul><ul class="nav navbar-nav navbar-left"><li role="presentation" class="hidden-sm"><a role="button" href="#"><span style="line-height:3;color:#FFFFFF;padding-bottom:10px;font-weight:300">Why Actionhero</span></a></li><li role="presentation" class=""><a role="button" href="#"><span style="line-height:3;color:#FFFFFF;padding-bottom:10px;font-weight:300">Downloads</span></a></li><li role="presentation" class=""><a role="button" href="#"><span style="line-height:3;color:#FFFFFF;padding-bottom:10px;font-weight:300">Tutorials</span></a></li><li role="presentation" class=""><a role="button" href="#"><span style="line-height:3;color:#FFFFFF;padding-bottom:10px;font-weight:300">Documentation</span></a></li><li role="presentation" class="hidden-sm"><a role="button" href="#"><span style="line-height:3;color:#FFFFFF;padding-bottom:10px;font-weight:300">Plugins</span></a></li><li role="presentation" class=""><a role="button" href="#"><span style="line-height:3;color:#FFFFFF;padding-bottom:10px;font-weight:300">Community</span></a></li><li role="presentation" class=""><a role="button" href="#"><span style="line-height:3;color:#FFFFFF;padding-bottom:10px;font-weight:300">Shop</span></a></li></ul><ul class="nav navbar-nav navbar-right"><div><a style="text-decoration:none" href="/get-started"><button style="font-family:Roboto, sans-serif;font-size:14px;max-width:200px;border-radius:50px;margin:0 auto;color:#FFFFFF;background-color:#E14E3A;border-color:#E14E3A;font-weight:300;margin-top:20px;margin-bottom:0;margin-left:10px;margin-right:10px;outline:none" type="button" class="btn btn-lg btn-default btn-block">Get Started</button></a></div></ul></div></div></nav></div></header></div><div style="padding-left:0;padding-right:0;font-family:Roboto, sans-serif;font-size:14px;font-weight:300" class="container-fluid"><div style="background-color:#FBF9E4;color:#2F5266;font-weight:200;padding:50px"><div class="container"><div class="row"><div style="text-align:center" class="col-md-3"><img src="/static/images/built-in-tasks.svg"/></div><div style="text-align:center" class="col-md-6"><h1 style="font-family:BebasNeue, Roboto, sans-serif;font-weight:bold;margin-top:20px;margin-bottom:10px;letter-spacing:2px;font-size:36px"><br/>Tasks</h1></div><div class="col-md-3"></div></div></div></div><div style="height:183px;background:url(&quot;/static/images/clouds-white.svg&quot;) no-repeat center #FBF9E4"></div><div style="padding-bottom:100px" class="container"><div class="row"><div id="_top"></div><div id="docPageContent" class="col-md-12"><div class="row"><div class="col-md-9"><div><br/><h2 id="Overview" style="font-family:Roboto, sans-serif;font-weight:300;font-size:20px;line-height:1.5em;color:#3B5D72"><span style="font-weight:300;font-size:36px">Overview</span></h2><hr style="color:#E14E3A;background-color:#E14E3A;border:0;height:2px"/></div><p>Tasks are background jobs meant to be run separately from a client&#x27;s request. They can be started by an action or by the server itself. With Actionhero, there is no need to run a separate daemon to process these jobs. Actionhero uses the <a href="https://github.com/Actionhero/node-resque">node-resque</a> package to store and process tasks in a way compatible with the <a href="https://github.com/resque/resque">resque</a> ecosystem.</p><p>There are 3 types of tasks Actionhero can process: <code>normal</code>, <code>delayed</code>, and <code>periodic</code>.</p><ul><li><code>normal</code> tasks are enqueued and processed one-by-one by the task TaskProcessors</li><li><code>delayed</code> tasks are enqueued in a special <code>delayed</code> queue to only be processed at some time in the future (defined either by a timestamp in ms or milliseconds-from-now)</li><li><code>periodic</code> tasks are like delayed tasks, but they run on a set frequency (e.g. every 5 minutes).<ul><li>Periodic tasks can take no input parameters.</li></ul></li></ul><div><br/><h2 id="Enqueing Tasks" style="font-family:Roboto, sans-serif;font-weight:300;font-size:20px;line-height:1.5em;color:#3B5D72"><span style="font-weight:300;font-size:36px">Enqueing Tasks</span></h2><hr style="color:#E14E3A;background-color:#E14E3A;border:0;height:2px"/></div><p>Here are examples of the 3 ways to programmatically enqueue a task:</p><pre style="display:block;overflow-x:auto;padding:0.5em;color:#000;background:#f8f8ff"><code>improt { task } <span style="color:#954121">from</span> <span style="color:#219161">&#x27;Actionhero&#x27;</span>

<span style="color:#408080;font-style:italic">// Enqueue the task now, and process it ASAP</span>
<span style="color:#954121">await</span> task.enqueue(
  <span style="color:#219161">&quot;sendWelcomeEmail&quot;</span>,
  { to: <span style="color:#219161">&quot;evan@evantahler.com&quot;</span> },
  <span style="color:#219161">&quot;default&quot;</span>
);

<span style="color:#408080;font-style:italic">// Enqueue the task now, and process it once \`timestamp\` has arrived</span>
<span style="color:#954121">await</span> task.enqueueAt(
  <span style="color:#40a070">1234556</span>,
  <span style="color:#219161">&quot;sendWelcomeEmail&quot;</span>,
  { to: <span style="color:#219161">&quot;evan@evantahler.com&quot;</span> },
  <span style="color:#219161">&quot;default&quot;</span>
);

<span style="color:#408080;font-style:italic">// Enqueue the task now, and process it once \`delay\` (ms) has passed</span>
<span style="color:#954121">await</span> task.enqueueIn(
  <span style="color:#40a070">10000</span>,
  <span style="color:#219161">&quot;sendWelcomeEmail&quot;</span>,
  { to: <span style="color:#219161">&quot;evan@evantahler.com&quot;</span> },
  <span style="color:#219161">&quot;default&quot;</span>
);</code></pre><p><code>sendWelcomeEmail</code> should be a task defined in the project, and <code>{to: &#x27;evan@evantahler.com&#x27;}</code> are arguments to that task. This task will be processed by TaskProcessors assigned to the &quot;default&quot; queue.</p><p>You can also enqueue tasks to be run at some time in the future (timestamp is in ms): <code>enqueueAt</code> asks for a timestamp (in ms) to run at, and <code>enqueueIn</code> asks for the number of ms from now to run.</p><p>The final type of task, periodic tasks, are defined with a <code>task.frequency</code> of greater than 0, and are loaded in by Actionhero when it boots. You cannot modify these tasks once the server is running.</p><div><br/><h2 id="Processing Tasks" style="font-family:Roboto, sans-serif;font-weight:300;font-size:20px;line-height:1.5em;color:#3B5D72"><span style="font-weight:300;font-size:36px">Processing Tasks</span></h2><hr style="color:#E14E3A;background-color:#E14E3A;border:0;height:2px"/></div><pre style="display:block;overflow-x:auto;padding:0.5em;color:#000;background:#f8f8ff"><code><span style="color:#408080;font-style:italic">// From /config/tasks.js:</span>

<span style="color:#954121">export</span> <span style="color:#954121">const</span> DEFAULT = {
  tasks: <span class="hljs-function"><span style="color:#00f">config</span> =&gt;</span> {
    <span style="color:#954121">return</span> {
      <span style="color:#408080;font-style:italic">// Should this node run a scheduler to promote delayed tasks?</span>
      scheduler: <span style="color:#954121">false</span>,
      <span style="color:#408080;font-style:italic">// what queues should the taskProcessors work?</span>
      queues: [<span style="color:#219161">&quot;*&quot;</span>],
      <span style="color:#408080;font-style:italic">// Logging levels of task workers</span>
      workerLogging: {
        failure: <span style="color:#219161">&quot;error&quot;</span>, <span style="color:#408080;font-style:italic">// task failure</span>
        success: <span style="color:#219161">&quot;info&quot;</span>, <span style="color:#408080;font-style:italic">// task success</span>
        start: <span style="color:#219161">&quot;info&quot;</span>,
        end: <span style="color:#219161">&quot;info&quot;</span>,
        cleaning_worker: <span style="color:#219161">&quot;info&quot;</span>,
        poll: <span style="color:#219161">&quot;debug&quot;</span>,
        job: <span style="color:#219161">&quot;debug&quot;</span>,
        pause: <span style="color:#219161">&quot;debug&quot;</span>,
        internalError: <span style="color:#219161">&quot;error&quot;</span>,
        multiWorkerAction: <span style="color:#219161">&quot;debug&quot;</span>
      },
      <span style="color:#408080;font-style:italic">// Logging levels of the task scheduler</span>
      schedulerLogging: {
        start: <span style="color:#219161">&quot;info&quot;</span>,
        end: <span style="color:#219161">&quot;info&quot;</span>,
        poll: <span style="color:#219161">&quot;debug&quot;</span>,
        enqueue: <span style="color:#219161">&quot;debug&quot;</span>,
        reEnqueue: <span style="color:#219161">&quot;debug&quot;</span>,
        working_timestamp: <span style="color:#219161">&quot;debug&quot;</span>,
        transferred_job: <span style="color:#219161">&quot;debug&quot;</span>
      },
      <span style="color:#408080;font-style:italic">// how long to sleep between jobs / scheduler checks</span>
      timeout: <span style="color:#40a070">5000</span>,
      <span style="color:#408080;font-style:italic">// at minimum, how many parallel taskProcessors should this node spawn?</span>
      <span style="color:#408080;font-style:italic">// (have number &gt; 0 to enable, and &lt; 1 to disable)</span>
      minTaskProcessors: <span style="color:#40a070">0</span>,
      <span style="color:#408080;font-style:italic">// at maximum, how many parallel taskProcessors should this node spawn?</span>
      maxTaskProcessors: <span style="color:#40a070">0</span>,
      <span style="color:#408080;font-style:italic">// how often should we check the event loop to spawn more taskProcessors?</span>
      checkTimeout: <span style="color:#40a070">500</span>,
      <span style="color:#408080;font-style:italic">// how many ms would constitue an event loop delay to halt taskProcessors spawning?</span>
      maxEventLoopDelay: <span style="color:#40a070">5</span>,
      <span style="color:#408080;font-style:italic">// how long before we mark a resque worker / task processor as stuck/dead?</span>
      stuckWorkerTimeout: <span style="color:#40a070">1000</span> * <span style="color:#40a070">60</span> * <span style="color:#40a070">60</span>,
      <span style="color:#408080;font-style:italic">// Customize Resque primitives, replace null with required replacement.</span>
      resque_overrides: {
        queue: <span style="color:#954121">null</span>,
        multiWorker: <span style="color:#954121">null</span>,
        scheduler: <span style="color:#954121">null</span>
      },
      connectionOptions: {
        tasks: {}
      }
    };
  }
};</code></pre><p>To work these tasks, you need to run Actionhero with at least one <code>taskProcessor</code>. <code>TaskProcessor</code>s run in-line with the rest of your server and process jobs. This is controlled by settings in <a href="https://github.com/Actionhero/Actionhero/blob/master/src/config/tasks.ts">/config/tasks.js</a>.</p><p>If you are enqueuing delayed or periodic tasks, you also need to enable the scheduler. This is a part of Actionhero that will periodically check the delayed queues for jobs that are ready to work now, and move them to the normal queues when the time comes.</p><p>Because node and Actionhero are asynchronous, we can process more than one job at a time. However, if the jobs we are processing are CPU-intensive, we want to limit how many we are working on at one time. To do this, we tell Actionhero to run somewhere between <code>minTaskProcessors</code> and <code>maxTaskProcessors</code> and check every so often if the server could be working more or less jobs at a time. Depending on the response characteristics you want for your server, you can modify these values.</p><p>In production, it is best to set up some Actionhero servers that only handle requests from clients (that is, servers with no TaskProcessors) and others that handle no requests, and only process jobs (that is, no servers, many <code>TaskProcessor</code>s).</p><p>As you noticed above, when you enqueue a task, you tell it which queue to be enqueued within. This is so you can separate load or priority. For example, you might have a <code>high</code> priority queue which does jobs like &quot;sendPushMessage&quot; and a <code>low</code> priority queue which does a task like &quot;cleanupCache&quot;. You tell the <code>taskProcessor</code>s which jobs to work, and in which priority. For the example above, you would ensure that all <code>high</code> jobs happen before all <code>low</code> jobs by setting: <code>api.config.tasks.queues = [&#x27;high&#x27;, &#x27;low&#x27;]</code>. You could also configure more nodes to work on the <code>high</code> queue than the <code>low</code> queue, thus further ensuring that <code>high</code> priority jobs are processed faster and sooner than <code>low</code> priority jobs.</p><div><br/><h2 id="Creating A Task" style="font-family:Roboto, sans-serif;font-weight:300;font-size:20px;line-height:1.5em;color:#3B5D72"><span style="font-weight:300;font-size:36px">Creating A Task</span></h2><hr style="color:#E14E3A;background-color:#E14E3A;border:0;height:2px"/></div><p>An few ways to define a task:</p><pre style="display:block;overflow-x:auto;padding:0.5em;color:#000;background:#f8f8ff"><code><span style="color:#408080;font-style:italic">// define a single task in a file</span>
<span style="color:#954121">import</span> { Task } <span style="color:#954121">from</span> <span style="color:#219161">&quot;Actionhero&quot;</span>;
<span style="color:#954121">import</span> { sendWelcomeEamail } <span style="color:#954121">from</span> <span style="color:#219161">&quot;./../modules/email&quot;</span>;

<span style="color:#954121">export</span> <span style="color:#954121">class</span> SendWelcomeMessage <span style="color:#954121">extends</span> Task {
  <span style="color:#954121">constructor</span>(<span style="color:#00f"></span>) {
    <span style="color:#954121">super</span>();
    <span style="color:#954121">this</span>.name = <span style="color:#219161">&quot;SendWelcomeEmail&quot;</span>;
    <span style="color:#954121">this</span>.description = <span style="color:#219161">&quot;I send the welcome email to new users&quot;</span>;
    <span style="color:#954121">this</span>.frequency = <span style="color:#40a070">0</span>;
    <span style="color:#954121">this</span>.queue = <span style="color:#219161">&quot;high&quot;</span>;
    <span style="color:#954121">this</span>.middleware = [];
  }

  <span style="color:#954121">async</span> run(data) {
    <span style="color:#954121">await</span> sendWelcomeEamail({ address: data.email });
    <span style="color:#954121">return</span> <span style="color:#954121">true</span>;
  }
}</code></pre><p>You can also define more than one task in a file, exporting each with a separate <code>exports</code> directive, ie:.</p><pre style="display:block;overflow-x:auto;padding:0.5em;color:#000;background:#f8f8ff"><code><span style="color:#954121">import</span> { Task } <span style="color:#954121">from</span> <span style="color:#219161">&quot;Actionhero&quot;</span>;

<span style="color:#954121">export</span> <span style="color:#954121">class</span> SayHello <span style="color:#954121">extends</span> Task {
  <span style="color:#954121">constructor</span>(<span style="color:#00f"></span>) {
    <span style="color:#954121">super</span>();
    <span style="color:#954121">this</span>.name = <span style="color:#219161">&quot;sayHello&quot;</span>;
    <span style="color:#954121">this</span>.description = <span style="color:#219161">&quot;I say hello&quot;</span>;
    <span style="color:#954121">this</span>.frequency = <span style="color:#40a070">1000</span>;
    <span style="color:#954121">this</span>.queue = <span style="color:#219161">&quot;low&quot;</span>;
    <span style="color:#954121">this</span>.middleware = [];
  }

  <span style="color:#954121">async</span> run() {
    api.log(<span style="color:#219161">&quot;hello&quot;</span>);
  }
}

<span style="color:#954121">export</span> <span style="color:#954121">class</span> SayGoodbye <span style="color:#954121">extends</span> Task {
  <span style="color:#954121">constructor</span>(<span style="color:#00f"></span>) {
    <span style="color:#954121">super</span>();
    <span style="color:#954121">this</span>.name = <span style="color:#219161">&quot;sayGoodbye&quot;</span>;
    <span style="color:#954121">this</span>.description = <span style="color:#219161">&quot;I say goodbye&quot;</span>;
    <span style="color:#954121">this</span>.frequency = <span style="color:#40a070">2000</span>;
    <span style="color:#954121">this</span>.queue = <span style="color:#219161">&quot;low&quot;</span>;
    <span style="color:#954121">this</span>.middleware = [];
  }

  <span style="color:#954121">async</span> run() {
    api.log(<span style="color:#219161">&quot;goodbye&quot;</span>);
  }
}</code></pre><p>Output of the above:</p><pre style="display:block;overflow-x:auto;padding:0.5em;color:#000;background:#f8f8ff"><code><span style="color:#408080;font-style:italic"># The output of running the last 2 tasks would be:</span>

2013-11-28 15:21:56 - debug: resque scheduler working timestamp 1385680913
2013-11-28 15:21:56 - debug: resque scheduler enquing job 1385680913 class=sayHello, queue=default,
2013-11-28 15:21:56 - debug: resque scheduler working timestamp 1385680914
2013-11-28 15:21:56 - debug: resque scheduler enquing job 1385680914 class=sayGoodbye, queue=default,
2013-11-28 15:21:56 - debug: resque worker <span style="color:#408080;font-style:italic">#1 working job default class=sayHello, queue=default,</span>
2013-11-28 15:21:56 - info: hello
2013-11-28 15:21:56 - debug: re-enqueued reccurent job sayHello
2013-11-28 15:21:56 - debug: resque worker <span style="color:#408080;font-style:italic">#1 working job default class=sayGoodbye, queue=default,</span>
2013-11-28 15:21:56 - info: goodbye
2013-11-28 15:21:56 - debug: re-enqueued reccurent job sayGoodbye</code></pre><p>You can create you own tasks by placing them in a <code>./tasks/</code> directory at the root of your application. You can use the generator <code>Actionhero generate task --name=myTask</code>. Like actions, all tasks have some required metadata:</p><ul><li><code>task.name</code>: The unique name of your task</li><li><code>task.description</code>: a description</li><li><code>task.queue</code>: the default queue to run this task within (can be overwritten when enqueued)</li><li><code>task.frequency</code>: In milliseconds, how often should I run?. A frequency of <code>&gt; 0</code> denotes this task as periodic and Actionhero will automatically enqueued when the server boots. Only one instance of a periodic task will be enqueued within the cluster at a time, regardless of how many Actionhero nodes are connected.</li><li><code>task.middleware</code>: middleware modify how your tasks are enqueued. For example, if you use the <code>queue-lock</code> plugin, only one instance of any job (with similar arguments) can be enqueued at a time. You can <a href="tutorial-middleware.html">learn more about middleware here</a></li></ul><p><code>task.run</code> contains the actual work that the task does. It takes the following arguments:</p><ul><li><code>params</code>: An array of parameters that the task was enqueued with. This is whatever was passed as the second argument to <code>api.tasks.enqueue</code>.</li></ul><p>Throwing an error will stop the task, and log it as a failure in resque, which you can inspect via the various <a href="api.tasks.html">tasks</a> methods. If a periodic task throws an error, it will not be run again.</p><div><br/><h2 id="Job Schedules" style="font-family:Roboto, sans-serif;font-weight:300;font-size:20px;line-height:1.5em;color:#3B5D72"><span style="font-weight:300;font-size:36px">Job Schedules</span></h2><hr style="color:#E14E3A;background-color:#E14E3A;border:0;height:2px"/></div><p>You may want to schedule jobs every minute/hour/day, like a distributed CRON job. There are a number of excellent node packages to help you with this, like <a href="https://github.com/tejasmanohar/node-schedule">node-schedule</a> and <a href="https://github.com/ncb000gt/node-cron">node-cron</a>. Actionhero exposes <a href="https://github.com/taskrabbit/node-resque">node-resque&#x27;s</a> scheduler to you so you can use the scheduler package of your choice.</p><p>Assuming you are running Actionhero across multiple machines, you will need to ensure that only one of your processes is actually scheduling the jobs. To help you with this, you can inspect which of the scheduler processes is correctly acting as master, and flag only the master scheduler process to run the schedule. An <a href="tutorial-initializers.html">initializer for this</a> would look like:</p><pre style="display:block;overflow-x:auto;padding:0.5em;color:#000;background:#f8f8ff"><code><span style="color:#408080;font-style:italic">// file: initializers/node_schedule.js</span>

<span style="color:#954121">import</span> * <span style="color:#954121">as</span> schedule <span style="color:#954121">from</span> <span style="color:#219161">&quot;node-schedule&quot;</span>;
<span style="color:#954121">import</span> { api, task, Initializer } <span style="color:#954121">from</span> <span style="color:#219161">&quot;Actionhero&quot;</span>;

<span style="color:#954121">export</span> <span style="color:#954121">class</span> Scheduler <span style="color:#954121">extends</span> Initializer {
  <span style="color:#954121">constructor</span>(<span style="color:#00f"></span>) {
    <span style="color:#954121">super</span>();
    <span style="color:#954121">this</span>.name = <span style="color:#219161">&quot;scheduler&quot;</span>;
  }

  initialize() {
    <span style="color:#954121">this</span>.scheduledJobs = [];
  }

  start() {
    <span style="color:#408080;font-style:italic">// do this job every 10 seconds, cron style</span>
    <span style="color:#954121">const</span> job = schedule.scheduleJob(<span style="color:#219161">&quot;0,10,20,30,40,50 * * * * *&quot;</span>, <span style="color:#954121">async</span> () =&gt; {
      <span style="color:#408080;font-style:italic">// we want to ensure that only one instance of this job is scheduled in our environment at once,</span>
      <span style="color:#408080;font-style:italic">// no matter how many schedulers we have running</span>
      <span style="color:#954121">if</span> (api.resque.scheduler &amp;&amp; api.resque.scheduler.master) {
        <span style="color:#954121">await</span> task.enqueue(
          <span style="color:#219161">&quot;sayHello&quot;</span>,
          { time: <span style="color:#954121">new</span> <span style="color:#0086b3">Date</span>().toString() },
          <span style="color:#219161">&quot;default&quot;</span>
        );
      }
    });

    <span style="color:#954121">this</span>.scheduledJobs.push(job);
  }

  stop() {
    <span style="color:#954121">this</span>.scheduledJobs.forEach(<span class="hljs-function"><span style="color:#00f">job</span> =&gt;</span> {
      job.cancel();
    });
  }
}</code></pre><p>Be sure to have the scheduler enabled on at least one of your Actionhero servers!</p><div><br/><h2 id="Failed Job Management" style="font-family:Roboto, sans-serif;font-weight:300;font-size:20px;line-height:1.5em;color:#3B5D72"><span style="font-weight:300;font-size:36px">Failed Job Management</span></h2><hr style="color:#E14E3A;background-color:#E14E3A;border:0;height:2px"/></div><p>Sometimes a worker crashes is a severe way, and it doesn&#x27;t get the time/chance to notify redis that it is leaving the pool (this happens all the time on PAAS providers like Heroku). When this happens, you will not only need to extract the job from the now-zombie worker&#x27;s &quot;working on&quot; status, but also remove the stuck worker. To aid you in these edge cases, <code>api.tasks.cleanOldWorkers(age)</code> is available.</p><p>Because there are no &#x27;heartbeats&#x27; in resque, it is impossible for the application to know if a worker has been working on a long job or it is dead. You are required to provide an &quot;age&quot; for how long a worker has been &quot;working&quot;, and all those older than that age will be removed, and the job they are working on moved to the error queue (where you can then use <code>api.tasks.retryAndRemoveFailed</code>) to re-enqueue the job.</p><p>You can handle this with an own initializer and the following logic:</p><pre style="display:block;overflow-x:auto;padding:0.5em;color:#000;background:#f8f8ff"><code><span style="color:#954121">import</span> { log, task } <span style="color:#954121">from</span> <span style="color:#219161">&quot;Actionhero&quot;</span>;

<span style="color:#954121">const</span> removeStuckWorkersOlderThan = <span style="color:#40a070">10000</span>; <span style="color:#408080;font-style:italic">// 10000ms</span>

log(
  <span style="color:#219161">`removing stuck workers solder than <span style="color:#954121">${removeStuckWorkersOlderThan}</span>ms`</span>,
  <span style="color:#219161">&quot;info&quot;</span>
);

<span style="color:#954121">const</span> result = task.cleanOldWorkers(removeStuckWorkersOlderThan);

<span style="color:#954121">if</span> (<span style="color:#0086b3">Object</span>.keys(result).length &gt; <span style="color:#40a070">0</span>) {
  log(<span style="color:#219161">&quot;removed stuck workers with errors: &quot;</span>, <span style="color:#219161">&quot;info&quot;</span>, result);
}</code></pre><div><br/><h2 id="Testing Tasks" style="font-family:Roboto, sans-serif;font-weight:300;font-size:20px;line-height:1.5em;color:#3B5D72"><span style="font-weight:300;font-size:36px">Testing Tasks</span></h2><hr style="color:#E14E3A;background-color:#E14E3A;border:0;height:2px"/></div><p>Taks are expected to be as lean as possible, with most of thier logic living in other methods you&#x27;ve created via initializers or middleware (or included via packages). This helps keep your task logic concicse, limited to excecution and scueduling... and the excecuting functions easier to test.</p><p>Actionhero ships with a method to help you check if a task is enqueued, <code>api.specHelper.findEnqueuedTasks(taskName)</code>:</p><pre style="display:block;overflow-x:auto;padding:0.5em;color:#000;background:#f8f8ff"><code><span style="color:#954121">import</span> { api, task } <span style="color:#954121">from</span> <span style="color:#219161">&quot;Actionhero&quot;</span>;

describe(<span style="color:#219161">&quot;task testing&quot;</span>, <span class="hljs-function"><span style="color:#00f">()</span> =&gt;</span> {
  beforeEach(<span style="color:#954121">async</span> () =&gt; {
    <span style="color:#408080;font-style:italic">// if you are testing taks, you likely want to start each test with an empty test redis</span>
    <span style="color:#954121">await</span> api.resque.queue.connection.redis.flushdb();
  });

  test(<span style="color:#219161">&quot;detect that a task was enqueued to run now&quot;</span>, <span style="color:#954121">async</span> () =&gt; {
    <span style="color:#954121">await</span> task.enqueue(<span style="color:#219161">&quot;regularTask&quot;</span>, { word: <span style="color:#219161">&quot;testing&quot;</span> });
    <span style="color:#954121">const</span> found = <span style="color:#954121">await</span> api.specHelper.findEnqueuedTasks(<span style="color:#219161">&quot;regularTask&quot;</span>);
    expect(found.length).toEqual(<span style="color:#40a070">1</span>);
    expect(found[<span style="color:#40a070">0</span>].args[<span style="color:#40a070">0</span>].word).toEqual(<span style="color:#219161">&quot;testing&quot;</span>);
    expect(found[<span style="color:#40a070">0</span>].timestamp).toBeNull();
  });
});</code></pre><div><br/><h2 id="Notes" style="font-family:Roboto, sans-serif;font-weight:300;font-size:20px;line-height:1.5em;color:#3B5D72"><span style="font-weight:300;font-size:36px">Notes</span></h2><hr style="color:#E14E3A;background-color:#E14E3A;border:0;height:2px"/></div><p>Note that the <code>frequency</code>, <code>enqueueIn</code> and <code>enqueueAt</code> times are when a task is <strong>allowed</strong> to run, not when it <strong>will</strong> run. TaskProcessors will work tasks in a first-in-first-out manner. TaskProcessors also <code>sleep</code> when there is no work to do, and will take some time (default 5 seconds) to wake up and check for more work to do.</p><p>Remember that each Actionhero server uses one thread and one event loop, so that if you have computationally intensive task (like computing Fibonacci numbers), this <strong>will</strong> block tasks, actions, and clients from working. However, if your tasks are meant to communicate with external services (reading from a database, sending an email, etc), then these are perfect candidates to be run simultaneously as the single thread can work on other things while waiting for these operations to complete.</p><p>If you are running a single Actionhero server, all tasks will be run locally. As you add more servers, the work will be split evenly across all nodes. It is very likely that your job will be run on different nodes each time.</p></div><div class="col-md-3"><div style="padding-top:90px"><ul style="list-style-type:none;padding-left:0;margin-left:0"></ul></div></div></div><hr/><p>Back to<!-- --> <a href="/tutorials">Tutorials</a></p></div><div class="hidden-xs hidden-sm col-md-3"></div></div></div><div style="background-color:#6E8898;color:#2F5266;font-weight:300;padding-top:100px;padding-bottom:100px"><div class="container"><div class="row"><div class="col-md-2"></div><div style="text-align:center;color:#FBF9E4;padding-bottom:100px" class="col-md-8"><h1 style="font-family:BebasNeue, Roboto, sans-serif;font-weight:bold;margin-top:20px;margin-bottom:10px;letter-spacing:2px;font-size:36px">Solutions</h1><h2 style="font-family:Roboto, sans-serif;font-weight:300;font-size:20px;line-height:1.5em;color:#3B5D72"><span style="color:#FBF9E4">Actionhero was built from the ground up to include all the features you expect from a modern API framework.</span></h2></div><div class="col-md-2"></div></div><div class="row"><div class="col-md-4"><div style="width:100%;padding-top:40px;padding-bottom:40px;padding-left:40px;padding-right:50px;background-color:#FBF9E4;box-shadow:0px 2px 4px #003C51"><div style="text-align:center;padding-bottom:10px"><h1 style="font-family:BebasNeue, Roboto, sans-serif;font-weight:bold;margin-top:20px;margin-bottom:10px;letter-spacing:2px;font-size:36px">Open Source</h1></div><hr style="color:#E14E3A;background-color:#E14E3A;border:0;height:2px"/><p>The Actionhero server is open source, under the Apache-2 license</p><hr style="color:#E14E3A;background-color:#E14E3A;border:0;height:2px"/><p>Actionhero runs on Linux, OS X, and Windows</p><hr style="color:#E14E3A;background-color:#E14E3A;border:0;height:2px"/><p>You always have access to the Actionhero team via<!-- --> <a href="/community">Slack and Github</a></p><br/><br/><div><a style="text-decoration:none" href="/downloads"><button style="font-family:Roboto, sans-serif;font-weight:300;font-size:14px;max-width:200px;border-radius:50px;margin:0 auto;color:#FFFFFF;background-color:#E14E3A;border-color:#E14E3A;margin-top:20px;margin-bottom:20px;padding-top:15px;padding-bottom:15px;outline:none" type="button" class="btn btn-lg btn-default btn-block">Download</button></a></div></div></div><div class="hidden-md hidden-lg hidden-xl col-md-4"><div style="width:100%;padding:20px;background-color:#2F5266;color:#FFFFFF;box-shadow:0px 2px 4px #003C51"><div style="text-align:center"><img src="/static/images/dog.svg"/><h1 style="font-family:BebasNeue, Roboto, sans-serif;font-weight:bold;margin-top:20px;margin-bottom:10px;letter-spacing:2px;font-size:36px"><span style="color:#FBF9E4">Premium Training &amp; Review</span></h1></div><hr style="color:#E14E3A;background-color:#E14E3A;border:0;height:2px"/><p>We provide support for corporate &amp; nonprofit customers starting at a flat rate of $150/hr. Our services include:</p><hr style="color:#E14E3A;background-color:#E14E3A;border:0;height:2px"/><ul><li><strong>Remote training for your team</strong></li><li><strong>Code Reviews</strong></li><li><strong>Best Practices Audits</strong></li><li><strong>Custom plugin &amp; Feature Development</strong></li></ul><hr style="color:#E14E3A;background-color:#E14E3A;border:0;height:2px"/><p>We have packages appropriate for all company sizes. Contact us to learn more.</p><br/><div><button style="font-family:Roboto, sans-serif;font-weight:300;font-size:14px;max-width:200px;border-radius:50px;margin:0 auto;color:#FFFFFF;background-color:#E14E3A;border-color:#E14E3A;margin-top:20px;margin-bottom:20px;padding-top:15px;padding-bottom:15px;outline:none" type="button" class="btn btn-lg btn-default btn-block">Contact Us</button></div></div></div><div class="hidden-xs hidden-sm col-md-4"><div style="width:125%;padding:40px;background-color:#2F5266;color:#FFFFFF;position:relative;top:-60px;box-shadow:0px 2px 4px #003C51;margin-left:-13%;margin-right:-5%;z-index:10"><div style="text-align:center;padding-bottom:10px"><img src="/static/images/dog.svg"/><h1 style="font-family:BebasNeue, Roboto, sans-serif;font-weight:bold;margin-top:20px;margin-bottom:10px;letter-spacing:2px;font-size:36px">Premium Training &amp; Review</h1></div><hr style="color:#E14E3A;background-color:#E14E3A;border:0;height:2px"/><p>We provide support for corperate &amp; nonprofit customers starting at a flat rate of $150/hr. Our services include:</p><hr style="color:#E14E3A;background-color:#E14E3A;border:0;height:2px"/><ul><li><strong>Remote training for your team</strong></li><li><strong>Code Reviews</strong></li><li><strong>Best Practices Workshops</strong></li><li><strong>Custom plugin &amp; Feature Development</strong></li></ul><hr style="color:#E14E3A;background-color:#E14E3A;border:0;height:2px"/><p>We have packages appropriate for all company sizes. Contact us to learn more.</p><br/><div><button style="font-family:Roboto, sans-serif;font-weight:300;font-size:14px;max-width:200px;border-radius:50px;margin:0 auto;color:#FFFFFF;background-color:#E14E3A;border-color:#E14E3A;margin-top:20px;margin-bottom:20px;padding-top:15px;padding-bottom:15px;outline:none" type="button" class="btn btn-lg btn-default btn-block">Contact Us</button></div></div></div><div class="col-md-4"><div style="width:100%;padding-top:40px;padding-bottom:40px;padding-right:40px;padding-left:50px;background-color:#FBF9E4;box-shadow:0px 2px 4px #003C51"><div style="text-align:center;padding-bottom:10px"><h1 style="font-family:BebasNeue, Roboto, sans-serif;font-weight:bold;margin-top:20px;margin-bottom:10px;letter-spacing:2px;font-size:36px">Enterprise</h1></div><hr style="color:#E14E3A;background-color:#E14E3A;border:0;height:2px"/><p>For larger customers in need of a support contract, we offer an enterprise plan including everything in the Premium plan plus:</p><hr style="color:#E14E3A;background-color:#E14E3A;border:0;height:2px"/><ul><li><strong>24/7 access to core members of the Actionhero Team</strong></li><li><strong>Emergency response packages</strong></li><li><strong>Deployment support</strong></li><li><strong>...and custom development against Actionhero’s core as needed.</strong></li></ul><br/><div><button style="font-family:Roboto, sans-serif;font-weight:300;font-size:14px;max-width:200px;border-radius:50px;margin:0 auto;color:#FFFFFF;background-color:#E14E3A;border-color:#E14E3A;margin-top:20px;margin-bottom:20px;padding-top:15px;padding-bottom:15px;outline:none" type="button" class="btn btn-lg btn-default btn-block">Contact Us</button></div></div></div></div></div></div></div><div style="padding-left:0;padding-right:0;font-family:Roboto, sans-serif;font-size:14px;font-weight:300" class="container-fluid"><footer id="footer-container" style="background-color:#2F5266;color:#FBF9E4;font-family:Roboto, sans-serif;font-weight:200"><div class="container"><div style="padding-bottom:50px;padding-top:50px;padding-left:100px" class="row"><div class="col-md-12"><img src="/static/images/actionhero-logo-header-wordmark.svg"/></div></div><div style="padding-bottom:100px" class="row"><div class="col-md-4"><div style="padding-left:100px"><p><a style="color:#FBF9E4" href="/terms">Terms</a></p><p>Contact us at<!-- --> <a style="color:#FBF9E4;font-weight:500" href="mailto:hello@actionherojs.com">hello@actionherojs.com</a></p><p><a href="https://medium.com/tag/actionherojs/latest" target="_new" style="color:#FBF9E4">Blogs</a></p><p>© 2019<!-- --> <!-- -->Actionhero</p></div></div><div class="col-md-4"><div style="padding-left:100px"><p><a style="color:#FBF9E4" href="/why">Why Actionhero</a></p><p><a style="color:#FBF9E4" href="/get-started">Get Started</a></p><p><a href="https://docs.actionherojs.com" style="color:#FBF9E4">Documenation</a></p><p><a style="color:#FBF9E4" href="/solutions">Solutions</a></p><p><a style="color:#FBF9E4" href="/community">Community</a></p><p><a style="color:#FBF9E4" href="/downloads">Downloads</a></p></div></div><div class="col-md-4"><div style="padding-left:100px"><p><a href="https://www.npmjs.com/package/Actionhero" target="_new" style="color:#FBF9E4">NPM</a></p><p><a href="https://twitter.com/actionherojs" target="_new" style="color:#FBF9E4">Twitter</a></p><p><a href="https://slack.actionherojs.com/" target="_new" style="color:#FBF9E4">Slack</a></p><p><a href="https://github.com/Actionhero/Actionhero" target="_new" style="color:#FBF9E4">Github</a></p><p><a href="https://actionherojs.threadless.com" target="_new" style="color:#FBF9E4">Shop</a></p></div></div></div></div></footer></div></div></div><script id="__NEXT_DATA__" type="application/json">{"dataManager":"[]","props":{"pageProps":{"markdown":"## Overview\n\nTasks are background jobs meant to be run separately from a client's request. They can be started by an action or by the server itself. With Actionhero, there is no need to run a separate daemon to process these jobs. Actionhero uses the [node-resque](https://github.com/Actionhero/node-resque) package to store and process tasks in a way compatible with the [resque](https://github.com/resque/resque) ecosystem.\n\nThere are 3 types of tasks Actionhero can process: `normal`, `delayed`, and `periodic`.\n\n- `normal` tasks are enqueued and processed one-by-one by the task TaskProcessors\n- `delayed` tasks are enqueued in a special `delayed` queue to only be processed at some time in the future (defined either by a timestamp in ms or milliseconds-from-now)\n- `periodic` tasks are like delayed tasks, but they run on a set frequency (e.g. every 5 minutes).\n  - Periodic tasks can take no input parameters.\n\n## Enqueing Tasks\n\nHere are examples of the 3 ways to programmatically enqueue a task:\n\n```ts\nimprot { task } from 'Actionhero'\n\n// Enqueue the task now, and process it ASAP\nawait task.enqueue(\n  \"sendWelcomeEmail\",\n  { to: \"evan@evantahler.com\" },\n  \"default\"\n);\n\n// Enqueue the task now, and process it once \\`timestamp\\` has arrived\nawait task.enqueueAt(\n  1234556,\n  \"sendWelcomeEmail\",\n  { to: \"evan@evantahler.com\" },\n  \"default\"\n);\n\n// Enqueue the task now, and process it once \\`delay\\` (ms) has passed\nawait task.enqueueIn(\n  10000,\n  \"sendWelcomeEmail\",\n  { to: \"evan@evantahler.com\" },\n  \"default\"\n);\n```\n\n`sendWelcomeEmail` should be a task defined in the project, and `{to: 'evan@evantahler.com'}` are arguments to that task. This task will be processed by TaskProcessors assigned to the \"default\" queue.\n\nYou can also enqueue tasks to be run at some time in the future (timestamp is in ms): `enqueueAt` asks for a timestamp (in ms) to run at, and `enqueueIn` asks for the number of ms from now to run.\n\nThe final type of task, periodic tasks, are defined with a `task.frequency` of greater than 0, and are loaded in by Actionhero when it boots. You cannot modify these tasks once the server is running.\n\n## Processing Tasks\n\n```ts\n// From /config/tasks.js:\n\nexport const DEFAULT = {\n  tasks: config =\u003e {\n    return {\n      // Should this node run a scheduler to promote delayed tasks?\n      scheduler: false,\n      // what queues should the taskProcessors work?\n      queues: [\"*\"],\n      // Logging levels of task workers\n      workerLogging: {\n        failure: \"error\", // task failure\n        success: \"info\", // task success\n        start: \"info\",\n        end: \"info\",\n        cleaning_worker: \"info\",\n        poll: \"debug\",\n        job: \"debug\",\n        pause: \"debug\",\n        internalError: \"error\",\n        multiWorkerAction: \"debug\"\n      },\n      // Logging levels of the task scheduler\n      schedulerLogging: {\n        start: \"info\",\n        end: \"info\",\n        poll: \"debug\",\n        enqueue: \"debug\",\n        reEnqueue: \"debug\",\n        working_timestamp: \"debug\",\n        transferred_job: \"debug\"\n      },\n      // how long to sleep between jobs / scheduler checks\n      timeout: 5000,\n      // at minimum, how many parallel taskProcessors should this node spawn?\n      // (have number \u003e 0 to enable, and \u003c 1 to disable)\n      minTaskProcessors: 0,\n      // at maximum, how many parallel taskProcessors should this node spawn?\n      maxTaskProcessors: 0,\n      // how often should we check the event loop to spawn more taskProcessors?\n      checkTimeout: 500,\n      // how many ms would constitue an event loop delay to halt taskProcessors spawning?\n      maxEventLoopDelay: 5,\n      // how long before we mark a resque worker / task processor as stuck/dead?\n      stuckWorkerTimeout: 1000 * 60 * 60,\n      // Customize Resque primitives, replace null with required replacement.\n      resque_overrides: {\n        queue: null,\n        multiWorker: null,\n        scheduler: null\n      },\n      connectionOptions: {\n        tasks: {}\n      }\n    };\n  }\n};\n```\n\nTo work these tasks, you need to run Actionhero with at least one `taskProcessor`. `TaskProcessor`s run in-line with the rest of your server and process jobs. This is controlled by settings in [/config/tasks.js](https://github.com/Actionhero/Actionhero/blob/master/src/config/tasks.ts).\n\nIf you are enqueuing delayed or periodic tasks, you also need to enable the scheduler. This is a part of Actionhero that will periodically check the delayed queues for jobs that are ready to work now, and move them to the normal queues when the time comes.\n\nBecause node and Actionhero are asynchronous, we can process more than one job at a time. However, if the jobs we are processing are CPU-intensive, we want to limit how many we are working on at one time. To do this, we tell Actionhero to run somewhere between `minTaskProcessors` and `maxTaskProcessors` and check every so often if the server could be working more or less jobs at a time. Depending on the response characteristics you want for your server, you can modify these values.\n\nIn production, it is best to set up some Actionhero servers that only handle requests from clients (that is, servers with no TaskProcessors) and others that handle no requests, and only process jobs (that is, no servers, many `TaskProcessor`s).\n\nAs you noticed above, when you enqueue a task, you tell it which queue to be enqueued within. This is so you can separate load or priority. For example, you might have a `high` priority queue which does jobs like \"sendPushMessage\" and a `low` priority queue which does a task like \"cleanupCache\". You tell the `taskProcessor`s which jobs to work, and in which priority. For the example above, you would ensure that all `high` jobs happen before all `low` jobs by setting: `api.config.tasks.queues = ['high', 'low']`. You could also configure more nodes to work on the `high` queue than the `low` queue, thus further ensuring that `high` priority jobs are processed faster and sooner than `low` priority jobs.\n\n## Creating A Task\n\nAn few ways to define a task:\n\n```ts\n// define a single task in a file\nimport { Task } from \"Actionhero\";\nimport { sendWelcomeEamail } from \"./../modules/email\";\n\nexport class SendWelcomeMessage extends Task {\n  constructor() {\n    super();\n    this.name = \"SendWelcomeEmail\";\n    this.description = \"I send the welcome email to new users\";\n    this.frequency = 0;\n    this.queue = \"high\";\n    this.middleware = [];\n  }\n\n  async run(data) {\n    await sendWelcomeEamail({ address: data.email });\n    return true;\n  }\n}\n```\n\nYou can also define more than one task in a file, exporting each with a separate `exports` directive, ie:.\n\n```ts\nimport { Task } from \"Actionhero\";\n\nexport class SayHello extends Task {\n  constructor() {\n    super();\n    this.name = \"sayHello\";\n    this.description = \"I say hello\";\n    this.frequency = 1000;\n    this.queue = \"low\";\n    this.middleware = [];\n  }\n\n  async run() {\n    api.log(\"hello\");\n  }\n}\n\nexport class SayGoodbye extends Task {\n  constructor() {\n    super();\n    this.name = \"sayGoodbye\";\n    this.description = \"I say goodbye\";\n    this.frequency = 2000;\n    this.queue = \"low\";\n    this.middleware = [];\n  }\n\n  async run() {\n    api.log(\"goodbye\");\n  }\n}\n```\n\nOutput of the above:\n\n```bash\n# The output of running the last 2 tasks would be:\n\n2013-11-28 15:21:56 - debug: resque scheduler working timestamp 1385680913\n2013-11-28 15:21:56 - debug: resque scheduler enquing job 1385680913 class=sayHello, queue=default,\n2013-11-28 15:21:56 - debug: resque scheduler working timestamp 1385680914\n2013-11-28 15:21:56 - debug: resque scheduler enquing job 1385680914 class=sayGoodbye, queue=default,\n2013-11-28 15:21:56 - debug: resque worker #1 working job default class=sayHello, queue=default,\n2013-11-28 15:21:56 - info: hello\n2013-11-28 15:21:56 - debug: re-enqueued reccurent job sayHello\n2013-11-28 15:21:56 - debug: resque worker #1 working job default class=sayGoodbye, queue=default,\n2013-11-28 15:21:56 - info: goodbye\n2013-11-28 15:21:56 - debug: re-enqueued reccurent job sayGoodbye\n```\n\nYou can create you own tasks by placing them in a `./tasks/` directory at the root of your application. You can use the generator `Actionhero generate task --name=myTask`. Like actions, all tasks have some required metadata:\n\n- `task.name`: The unique name of your task\n- `task.description`: a description\n- `task.queue`: the default queue to run this task within (can be overwritten when enqueued)\n- `task.frequency`: In milliseconds, how often should I run?. A frequency of `\u003e 0` denotes this task as periodic and Actionhero will automatically enqueued when the server boots. Only one instance of a periodic task will be enqueued within the cluster at a time, regardless of how many Actionhero nodes are connected.\n- `task.middleware`: middleware modify how your tasks are enqueued. For example, if you use the `queue-lock` plugin, only one instance of any job (with similar arguments) can be enqueued at a time. You can [learn more about middleware here](tutorial-middleware.html)\n\n`task.run` contains the actual work that the task does. It takes the following arguments:\n\n- `params`: An array of parameters that the task was enqueued with. This is whatever was passed as the second argument to `api.tasks.enqueue`.\n\nThrowing an error will stop the task, and log it as a failure in resque, which you can inspect via the various [tasks](api.tasks.html) methods. If a periodic task throws an error, it will not be run again.\n\n## Job Schedules\n\nYou may want to schedule jobs every minute/hour/day, like a distributed CRON job. There are a number of excellent node packages to help you with this, like [node-schedule](https://github.com/tejasmanohar/node-schedule) and [node-cron](https://github.com/ncb000gt/node-cron). Actionhero exposes [node-resque's](https://github.com/taskrabbit/node-resque) scheduler to you so you can use the scheduler package of your choice.\n\nAssuming you are running Actionhero across multiple machines, you will need to ensure that only one of your processes is actually scheduling the jobs. To help you with this, you can inspect which of the scheduler processes is correctly acting as master, and flag only the master scheduler process to run the schedule. An [initializer for this](tutorial-initializers.html) would look like:\n\n```ts\n// file: initializers/node_schedule.js\n\nimport * as schedule from \"node-schedule\";\nimport { api, task, Initializer } from \"Actionhero\";\n\nexport class Scheduler extends Initializer {\n  constructor() {\n    super();\n    this.name = \"scheduler\";\n  }\n\n  initialize() {\n    this.scheduledJobs = [];\n  }\n\n  start() {\n    // do this job every 10 seconds, cron style\n    const job = schedule.scheduleJob(\"0,10,20,30,40,50 * * * * *\", async () =\u003e {\n      // we want to ensure that only one instance of this job is scheduled in our environment at once,\n      // no matter how many schedulers we have running\n      if (api.resque.scheduler \u0026\u0026 api.resque.scheduler.master) {\n        await task.enqueue(\n          \"sayHello\",\n          { time: new Date().toString() },\n          \"default\"\n        );\n      }\n    });\n\n    this.scheduledJobs.push(job);\n  }\n\n  stop() {\n    this.scheduledJobs.forEach(job =\u003e {\n      job.cancel();\n    });\n  }\n}\n```\n\nBe sure to have the scheduler enabled on at least one of your Actionhero servers!\n\n## Failed Job Management\n\nSometimes a worker crashes is a severe way, and it doesn't get the time/chance to notify redis that it is leaving the pool (this happens all the time on PAAS providers like Heroku). When this happens, you will not only need to extract the job from the now-zombie worker's \"working on\" status, but also remove the stuck worker. To aid you in these edge cases, `api.tasks.cleanOldWorkers(age)` is available.\n\nBecause there are no 'heartbeats' in resque, it is impossible for the application to know if a worker has been working on a long job or it is dead. You are required to provide an \"age\" for how long a worker has been \"working\", and all those older than that age will be removed, and the job they are working on moved to the error queue (where you can then use `api.tasks.retryAndRemoveFailed`) to re-enqueue the job.\n\nYou can handle this with an own initializer and the following logic:\n\n```ts\nimport { log, task } from \"Actionhero\";\n\nconst removeStuckWorkersOlderThan = 10000; // 10000ms\n\nlog(\n  `removing stuck workers solder than ${removeStuckWorkersOlderThan}ms`,\n  \"info\"\n);\n\nconst result = task.cleanOldWorkers(removeStuckWorkersOlderThan);\n\nif (Object.keys(result).length \u003e 0) {\n  log(\"removed stuck workers with errors: \", \"info\", result);\n}\n```\n\n## Testing Tasks\n\nTaks are expected to be as lean as possible, with most of thier logic living in other methods you've created via initializers or middleware (or included via packages). This helps keep your task logic concicse, limited to excecution and scueduling... and the excecuting functions easier to test.\n\nActionhero ships with a method to help you check if a task is enqueued, `api.specHelper.findEnqueuedTasks(taskName)`:\n\n```ts\nimport { api, task } from \"Actionhero\";\n\ndescribe(\"task testing\", () =\u003e {\n  beforeEach(async () =\u003e {\n    // if you are testing taks, you likely want to start each test with an empty test redis\n    await api.resque.queue.connection.redis.flushdb();\n  });\n\n  test(\"detect that a task was enqueued to run now\", async () =\u003e {\n    await task.enqueue(\"regularTask\", { word: \"testing\" });\n    const found = await api.specHelper.findEnqueuedTasks(\"regularTask\");\n    expect(found.length).toEqual(1);\n    expect(found[0].args[0].word).toEqual(\"testing\");\n    expect(found[0].timestamp).toBeNull();\n  });\n});\n```\n\n## Notes\n\nNote that the `frequency`, `enqueueIn` and `enqueueAt` times are when a task is **allowed** to run, not when it **will** run. TaskProcessors will work tasks in a first-in-first-out manner. TaskProcessors also `sleep` when there is no work to do, and will take some time (default 5 seconds) to wake up and check for more work to do.\n\nRemember that each Actionhero server uses one thread and one event loop, so that if you have computationally intensive task (like computing Fibonacci numbers), this **will** block tasks, actions, and clients from working. However, if your tasks are meant to communicate with external services (reading from a database, sending an email, etc), then these are perfect candidates to be run simultaneously as the single thread can work on other things while waiting for these operations to complete.\n\nIf you are running a single Actionhero server, all tasks will be run locally. As you add more servers, the work will be split evenly across all nodes. It is very likely that your job will be run on different nodes each time.\n","name":"tasks"}},"page":"/tutorials/[name]","query":{"name":"tasks"},"buildId":"LBfMmkKIbhjxYUodTJOk3","nextExport":true}</script><script nomodule="" src="/_next/static/runtime/polyfills-099147a670e7b68459d6.js"></script><script async="" data-next-page="/tutorials/[name]" src="/_next/static/LBfMmkKIbhjxYUodTJOk3/pages/tutorials/%5Bname%5D.js"></script><script async="" data-next-page="/_app" src="/_next/static/LBfMmkKIbhjxYUodTJOk3/pages/_app.js"></script><script src="/_next/static/runtime/webpack-08f7b238829422e3b9b2.js" async=""></script><script src="/_next/static/chunks/commons.205aac1996ebb87d3a48.js" async=""></script><script src="/_next/static/runtime/main-2325b25da04a50e601b5.js" async=""></script></body></html>