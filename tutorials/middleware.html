<!DOCTYPE html><html><head><meta charSet="utf-8"/><link rel="apple-touch-icon" sizes="57x57" href="/static/images/icons/apple-icon-57x57.png"/><link rel="apple-touch-icon" sizes="60x60" href="/static/images/icons/apple-icon-60x60.png"/><link rel="apple-touch-icon" sizes="72x72" href="/static/images/icons/apple-icon-72x72.png"/><link rel="apple-touch-icon" sizes="76x76" href="/static/images/icons/apple-icon-76x76.png"/><link rel="apple-touch-icon" sizes="114x114" href="/static/images/icons/apple-icon-114x114.png"/><link rel="apple-touch-icon" sizes="120x120" href="/static/images/icons/apple-icon-120x120.png"/><link rel="apple-touch-icon" sizes="144x144" href="/static/images/icons/apple-icon-144x144.png"/><link rel="apple-touch-icon" sizes="152x152" href="/static/images/icons/apple-icon-152x152.png"/><link rel="apple-touch-icon" sizes="180x180" href="/static/images/icons/apple-icon-180x180.png"/><link rel="icon" type="image/png" sizes="192x192" href="/static/images/icons/android-icon-192x192.png"/><link rel="icon" type="image/png" sizes="32x32" href="/static/images/icons/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="96x96" href="/static/images/icons/favicon-96x96.png"/><link rel="icon" type="image/png" sizes="16x16" href="/static/images/icons/favicon-16x16.png"/><meta name="viewport" content="width=device-width"/><link rel="stylesheet" type="text/css" href="/static/css/bootstrap.min.css"/><link rel="stylesheet" type="text/css" href="/static/css/bebasNeue.css"/><link rel="stylesheet" type="text/css" href="/static/css/animations.css"/><link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,700,800|Roboto:100,300,400,500,700,900" rel="stylesheet"/><title>Actionhero</title><script src="/static/js/googleAnalytics.js"></script><meta name="next-head-count" content="21"/><link rel="preload" href="/_next/static/aqoaiQGeKF7QCoiTT0lOb/pages/tutorials/%5Bname%5D.js" as="script"/><link rel="preload" href="/_next/static/aqoaiQGeKF7QCoiTT0lOb/pages/_app.js" as="script"/><link rel="preload" href="/_next/static/runtime/webpack-91b117697e716c22a78b.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.dbd31ae8fa0e794339d4.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.951ee3a86146f43ff3ef.js" as="script"/><link rel="preload" href="/_next/static/runtime/main-a439f05c489a40fb8abf.js" as="script"/><link rel="preload" href="/_next/static/chunks/e4d398197e5ec3535efaf346b243226a3bd3651f.df8ba5aacf2336156dd7.js" as="script"/><link rel="preload" href="/_next/static/chunks/f36d4fcc976e79064dae3de7ac516f908d662d29.fee39761db1fc475c2ba.js" as="script"/><link rel="preload" href="/_next/static/chunks/631952ed33728d5ceeac998142777c3b5b7644ad.f4cec1a1186f868c77e4.js" as="script"/></head><body><div id="__next"><div><div style="padding-left:0;padding-right:0;font-family:Roboto, sans-serif;font-size:14px;font-weight:300" class="container-fluid"><div style="text-align:center;padding:10px;background-color:#FFFFFF;border-bottom:5px solid #E14E3A"><p><strong>We need your input!</strong><br/><br/>The Actionhero Team is working on our plans for 2020 and would like to solicit input from our community. <br/>Please take 5 to complete our<!-- --> <strong><a href="https://forms.gle/ZMmCqGN7pvgHKdz57" target="_blank">2020 Developer Survey</a></strong>! .</p></div><header style="background-color:#2F5266"><div class="container"><nav style="background-color:#2F5266;padding-top:5px;margin-bottom:10px;border:0" class="navbar navbar-default"><div class="container"><div class="navbar-header"><a style="padding-top:0;margin-bottom:15px" class="navbar-brand"><img src="/static/images/actionhero-logo-header-wordmark.svg" style="padding-top:14px;padding-bottom:20px"/></a><button type="button" class="navbar-toggle collapsed"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button></div><div class="navbar-collapse collapse"><ul class="nav navbar-nav navbar-right"></ul><ul class="hidden-md hidden-sm hidden-xs nav navbar-nav navbar-left"><li role="presentation" class=""><a role="button" href="#"> </a></li><li role="presentation" class=""><a role="button" href="#"> </a></li></ul><ul class="nav navbar-nav navbar-left"><li role="presentation" class="hidden-sm"><a role="button" href="#"><span style="line-height:3;color:#FFFFFF;padding-bottom:10px;font-weight:300">Why Actionhero</span></a></li><li role="presentation" class=""><a role="button" href="#"><span style="line-height:3;color:#FFFFFF;padding-bottom:10px;font-weight:300">Downloads</span></a></li><li role="presentation" class=""><a role="button" href="#"><span style="line-height:3;color:#FFFFFF;padding-bottom:10px;font-weight:300">Tutorials</span></a></li><li role="presentation" class=""><a role="button" href="#"><span style="line-height:3;color:#FFFFFF;padding-bottom:10px;font-weight:300">Documentation</span></a></li><li role="presentation" class="hidden-sm"><a role="button" href="#"><span style="line-height:3;color:#FFFFFF;padding-bottom:10px;font-weight:300">Plugins</span></a></li><li role="presentation" class=""><a role="button" href="#"><span style="line-height:3;color:#FFFFFF;padding-bottom:10px;font-weight:300">Community</span></a></li><li role="presentation" class=""><a role="button" href="#"><span style="line-height:3;color:#FFFFFF;padding-bottom:10px;font-weight:300">Shop</span></a></li></ul><ul class="nav navbar-nav navbar-right"><div><a style="text-decoration:none" href="/get-started"><button style="font-family:Roboto, sans-serif;font-size:14px;max-width:200px;border-radius:50px;margin:0 auto;color:#FFFFFF;background-color:#E14E3A;border-color:#E14E3A;font-weight:300;margin-top:20px;margin-bottom:0;margin-left:10px;margin-right:10px;outline:none" type="button" class="btn btn-lg btn-default btn-block">Get Started</button></a></div></ul></div></div></nav></div></header></div><div style="padding-left:0;padding-right:0;font-family:Roboto, sans-serif;font-size:14px;font-weight:300" class="container-fluid"><div style="background-color:#FBF9E4;color:#2F5266;font-weight:200;padding:50px"><div class="container"><div class="row"><div style="text-align:center" class="col-md-3"><img src="/static/images/api-first-development.svg"/></div><div style="text-align:center" class="col-md-6"><h1 style="font-family:BebasNeue, Roboto, sans-serif;font-weight:bold;margin-top:20px;margin-bottom:10px;letter-spacing:2px;font-size:36px"><br/>Middleware</h1></div><div class="col-md-3"></div></div></div></div><div style="height:183px;background:url(&quot;/static/images/clouds-white.svg&quot;) no-repeat center #FBF9E4"></div><div style="padding-bottom:100px" class="container"><div class="row"><div id="_top"></div><div id="docPageContent" class="col-md-12"><div id="tutorialPageContent" class="row"><div class="col-md-9"><div><div id="Overview"><br/><h2 style="font-family:Roboto, sans-serif;font-weight:300;font-size:20px;line-height:1.5em;color:#3B5D72"><span style="font-weight:300;font-size:36px">Overview</span></h2><hr style="color:#E14E3A;background-color:#E14E3A;border:0;height:2px"/></div></div><p>There are 4 types of middleware in Actionhero:</p><ul><li><strong>Action</strong></li><li><strong>Connection</strong></li><li><strong>Chat</strong></li><li><strong>Task</strong></li></ul><p>Each type of middleware is distinct from the others, and operates on distinct parts of a client&#x27;s lifecycle. For a logical example, please inspect the following connection lifecycle:</p><pre style="display:block;overflow-x:auto;padding:0.5em;color:#000;background:#f8f8ff"><code>&gt; Client **Connects**
<span style="color:#408080;font-style:italic"># connection middleware, \`create\` hook</span>

&gt; Client requests an **action**
<span style="color:#408080;font-style:italic"># action middleware, \`preProcessor\` hook</span>
<span style="color:#408080;font-style:italic"># action middleware, \`postProcessor\` hook</span>

&gt; Client **joins a room**
<span style="color:#408080;font-style:italic"># chat middleware, \`join\` hook</span>

&gt; Client **says a message** <span style="color:#954121">in</span> a room
<span style="color:#408080;font-style:italic"># chat middleware, \`say\` hook</span>
<span style="color:#408080;font-style:italic"># chat middleware, \`onSayReceive\` hook</span>

&gt; Client requests a **disconnect** (quit)
<span style="color:#408080;font-style:italic"># chat middleware, \`leave\` hook</span>
<span style="color:#408080;font-style:italic"># connection middleware, \`destroy\` hook</span>

&gt; Client executes a **task**
<span style="color:#408080;font-style:italic"># task middleware, \`preProcessor\` hook</span>
<span style="color:#408080;font-style:italic"># task middleware, \`postProcessor\` hook</span></code></pre><div><div id="Action Middleware"><br/><h2 style="font-family:Roboto, sans-serif;font-weight:300;font-size:20px;line-height:1.5em;color:#3B5D72"><span style="font-weight:300;font-size:36px">Action Middleware</span></h2><hr style="color:#E14E3A;background-color:#E14E3A;border:0;height:2px"/></div></div><p><img alt="/static/images/tutorials/connection_flow_actions.png" src="/static/images/tutorials/connection_flow_actions.png"/></p><pre style="display:block;overflow-x:auto;padding:0.5em;color:#000;background:#f8f8ff"><code><span style="color:#954121">import</span> { action } <span style="color:#954121">from</span> <span style="color:#219161">&quot;actionhero&quot;</span>;

<span style="color:#954121">const</span> middleware = {
  name: <span style="color:#219161">&quot;userId checker&quot;</span>,
  global: <span style="color:#954121">false</span>,
  priority: <span style="color:#40a070">1000</span>,
  preProcessor: <span class="hljs-function"><span style="color:#00f">data</span> =&gt;</span> {
    <span style="color:#954121">if</span> (!data.params.userId) {
      <span style="color:#954121">throw</span> <span style="color:#954121">new</span> <span style="color:#0086b3">Error</span>(<span style="color:#219161">&quot;All actions require a userId&quot;</span>);
    }
  },
  postProcessor: <span class="hljs-function"><span style="color:#00f">data</span> =&gt;</span> {
    <span style="color:#954121">if</span> (data.thing.stuff == <span style="color:#954121">false</span>) {
      data.toRender = <span style="color:#954121">false</span>;
    }
  }
};

action.addMiddleware(middleware);</code></pre><p>actionhero provides hooks for you to execute custom code both before and after the execution of all or some actions. This is a great place to write authentication logic or custom loggers.</p><p>Action middleware requires a <code>name</code> and at least one of <code>preProcessor</code> or <code>postProcessor</code>. Middleware can be <code>global</code>, or you can choose to apply each middleware to an action specifically via <code>action.middleware = []</code> in the action&#x27;s definition. You supply a list of middleware names, like <code>action.middleware = [&#x27;userId checker&#x27;]</code> in the example above.</p><p>Each processor is passed <code>data</code>. Just like within actions, you can modify the <code>data</code> object to add to <code>data.response</code> to create a response to the client. If an error is thrown, the action will not execute, and <code>data.response.error</code> will contain the error. If a <code>preProcessor</code> has an error, the action will never be called.</p><p>The priority of a middleware orders it with all other middleware which might fire for an action. All global middleware happen before locally defined middleware on an action. Lower numbers happen first. If you do not provide a priority, the default from <code>api.config.general.defaultProcessorPriority</code> will be used.</p><div><div id="The Data Object"><br/><h2 style="font-family:Roboto, sans-serif;font-weight:300;font-size:20px;line-height:1.5em;color:#3B5D72"><span style="font-weight:300;font-size:36px">The Data Object</span></h2><hr style="color:#E14E3A;background-color:#E14E3A;border:0;height:2px"/></div></div><p><code>data</code> contains the same information as would be passed to an action:</p><pre style="display:block;overflow-x:auto;padding:0.5em;color:#000;background:#f8f8ff"><code>data = {
  connection: {},
  action: <span style="color:#219161">&quot;randomNumber&quot;</span>,
  toRender: <span style="color:#954121">true</span>,
  messageId: <span style="color:#40a070">1</span>,
  params: { action: <span style="color:#219161">&quot;randomNumber&quot;</span>, apiVersion: <span style="color:#40a070">1</span> },
  actionStartTime: <span style="color:#40a070">1429531553417</span>,
  actionTemplate: {}, <span style="color:#408080;font-style:italic">// the actual object action definition</span>
  response: {},
  session: {}
};</code></pre><p>If your middleware wants to pass information about the connection to the action, place that data within the <code>session</code> object. For example, you might have a middleware that sets <code>session.user</code> for use in your actions:</p><pre style="display:block;overflow-x:auto;padding:0.5em;color:#000;background:#f8f8ff"><code><span style="color:#954121">import</span> { action } <span style="color:#954121">from</span> <span style="color:#219161">&quot;actionhero&quot;</span>;
<span style="color:#954121">import</span> { Team, TeamMember } <span style="color:#954121">from</span> <span style="color:#219161">&quot;./../models&quot;</span>; <span style="color:#408080;font-style:italic">// defined in your project</span>

<span style="color:#954121">const</span> authenticatedUserMiddleware = {
  name: <span style="color:#219161">&quot;authenticated-team-member&quot;</span>,
  global: <span style="color:#954121">false</span>,
  priority: <span style="color:#40a070">1000</span>,
  preProcessor: <span style="color:#954121">async</span> data =&gt; {
    <span style="color:#954121">const</span> sessionData = <span style="color:#954121">await</span> api.session.load(data.connection);
    <span style="color:#954121">if</span> (!sessionData) {
      <span style="color:#954121">throw</span> <span style="color:#954121">new</span> <span style="color:#0086b3">Error</span>(<span style="color:#219161">&quot;Please log in to continue&quot;</span>);
    } <span style="color:#954121">else</span> <span style="color:#954121">if</span> (
      !data.params.csrfToken ||
      data.params.csrfToken !== sessionData.csrfToken
    ) {
      <span style="color:#954121">throw</span> <span style="color:#954121">new</span> <span style="color:#0086b3">Error</span>(<span style="color:#219161">&quot;CSRF error&quot;</span>);
    } <span style="color:#954121">else</span> {
      <span style="color:#954121">const</span> teamMember = <span style="color:#954121">await</span> TeamMember.findOne({
        where: { guid: sessionData.guid },
        include: Team
      });
      data.session = { data: sessionData, teamMember };
    }
  }
};

action.addMiddleware(authenticatedUserMiddleware);</code></pre><div><div id="Connection Middleware"><br/><h2 style="font-family:Roboto, sans-serif;font-weight:300;font-size:20px;line-height:1.5em;color:#3B5D72"><span style="font-weight:300;font-size:36px">Connection Middleware</span></h2><hr style="color:#E14E3A;background-color:#E14E3A;border:0;height:2px"/></div></div><pre style="display:block;overflow-x:auto;padding:0.5em;color:#000;background:#f8f8ff"><code><span style="color:#954121">import</span> { log, connection } <span style="color:#954121">from</span> <span style="color:#219161">&quot;actionhero&quot;</span>;

<span style="color:#954121">const</span> connectionMiddleware = {
  name: <span style="color:#219161">&quot;connection middleware&quot;</span>,
  priority: <span style="color:#40a070">1000</span>,
  create: <span style="color:#954121">async</span> connection =&gt; {
    log(<span style="color:#219161">&quot;connection joined&quot;</span>);
  },
  destroy: <span style="color:#954121">async</span> connection =&gt; {
    log(<span style="color:#219161">&quot;connection left&quot;</span>);
  }
};

connection.addMiddleware(connectionMiddleware);</code></pre><p>Like the action middleware above, you can also create middleware to react to the creation or destruction of all connections.</p><p>Keep in mind that some connections persist (webSocket, socket) and some only exist for the duration of a single request (web). You will likely want to inspect <code>connection.type</code> in this middleware. Again, if you do not provide a priority, the default from <code>api.config.general.defaultMiddlewarePriority</code> will be used.</p><p>Any modification made to the connection at this stage may happen either before or after an action, and may or may not persist to the connection depending on how the server is implemented.</p><div><div id="Chat Middleware"><br/><h2 style="font-family:Roboto, sans-serif;font-weight:300;font-size:20px;line-height:1.5em;color:#3B5D72"><span style="font-weight:300;font-size:36px">Chat Middleware</span></h2><hr style="color:#E14E3A;background-color:#E14E3A;border:0;height:2px"/></div></div><pre style="display:block;overflow-x:auto;padding:0.5em;color:#000;background:#f8f8ff"><code><span style="color:#954121">import</span> { log, chatRoom, connection } <span style="color:#954121">from</span> <span style="color:#219161">&quot;actionhero&quot;</span>;

<span style="color:#954121">var</span> chatMiddleware = {
  name: <span style="color:#219161">&quot;chat middleware&quot;</span>,
  priority: <span style="color:#40a070">1000</span>,
  join: <span class="hljs-function">(<span style="color:#00f">connection, room</span>) =&gt;</span> {
    <span style="color:#408080;font-style:italic">// announce all connections entering a room</span>
    <span style="color:#954121">await</span> chatRoom.broadcast(
      {},
      room,
      <span style="color:#219161">&quot;I have joined the room: &quot;</span> + connection.id
    );
  },
  leave: <span class="hljs-function">(<span style="color:#00f">connection, room</span>) =&gt;</span> {
    <span style="color:#408080;font-style:italic">// announce all connections leaving a room</span>
    <span style="color:#954121">await</span> chatRoom.broadcast(
      {},
      room,
      <span style="color:#219161">&quot;I have left the room: &quot;</span> + connection.id
    );
  },
  <span style="color:#408080;font-style:italic">/**
   * Will be executed once per client connection before delivering the message.
   */</span>
  say: <span class="hljs-function">(<span style="color:#00f">connection, room, messagePayload</span>) =&gt;</span> {
    <span style="color:#408080;font-style:italic">// do stuff</span>
    log(messagePayload);
    messagePayload.cool = <span style="color:#954121">true</span>;
    <span style="color:#954121">return</span> messagePayload;
  },
  <span style="color:#408080;font-style:italic">/**
   * Will be executed only once, when the message is sent to the server.
   */</span>
  onSayReceive: <span class="hljs-function"><span style="color:#954121">function</span>(<span style="color:#00f">connection, room, messagePayload</span>) </span>{
    <span style="color:#408080;font-style:italic">// do stuff</span>
    log(messagePayload);
    messagePayload.receivedAt = <span style="color:#954121">new</span> <span style="color:#0086b3">Date</span>().getTime();
    <span style="color:#954121">return</span> messagePayload;
  }
};

chatRoom.addMiddleware(chatMiddleware);</code></pre><p>The last type of middleware is used to act when a connection joins, leaves, or communicates within a chat room. We have 4 types of middleware for each step: <code>say</code>, <code>onSayReceive</code>, <code>join</code>, and <code>leave</code>.</p><p>Priority is optional in all cases, but can be used to order your middleware. If an error is returned thrown any of these methods, it will be returned to the client, and the action/verb/message will not be sent.</p><p>More detail and nuance on chat middleware can be found in the <a href="tutorial-chat.html">chat tutorial</a></p><div><div id="Chat Middleware Notes"><br/><h2 style="font-family:Roboto, sans-serif;font-weight:300;font-size:20px;line-height:1.5em;color:#3B5D72"><span style="font-weight:300;font-size:36px">Chat Middleware Notes</span></h2><hr style="color:#E14E3A;background-color:#E14E3A;border:0;height:2px"/></div></div><ul><li>In the example above, I want to announce the member joining the room, but he has not yet been added to the room, as the join logic is still firing. If the connection itself were to make the broadcast, it would fail because the connection is not in the room. Instead, an empty <code>{}</code> connection is used to proxy the message coming from the &#x27;server&#x27;.</li><li>Only the <code>sayCallbacks</code> return <code>messagePayload</code>. This allows you to modify the message being sent to your clients.<ul><li><code>messagePayload</code> will be modified and and passed on to all middleware inline, so you can append and modify it as you go</li></ul></li><li>If you have a number of callbacks (<code>say</code>, <code>onSayReceive</code>, <code>join</code> or <code>leave</code>), the priority maters, and you can block subsequent methods from firing by throwing an error.</li><li><code>sayCallbacks</code> are executed once per client connection. This makes it suitable for customizing the message based on the individual client.</li><li><code>onSayReceiveCallbacks</code> are executed only once, when the message is sent to the server.</li></ul><pre style="display:block;overflow-x:auto;padding:0.5em;color:#000;background:#f8f8ff"><code><span style="color:#954121">import</span> {chatRoom, connection} <span style="color:#954121">from</span> <span style="color:#219161">&#x27;actionhero&#x27;</span>;

<span style="color:#408080;font-style:italic">// in this example no one will be able to join any room, and the \`say\` middleware will never be invoked.</span>
chatRoom.addMiddleware({
  name: <span style="color:#219161">&#x27;blocking chat middleware&#x27;</span>,
  join: <span class="hljs-function">(<span style="color:#00f">connection, room</span>) =&gt;</span> {
    <span style="color:#954121">throw</span> <span style="color:#954121">new</span> <span style="color:#0086b3">Error</span>(<span style="color:#219161">&#x27;blocked from joining the room&#x27;</span>)
  }),

  say: <span class="hljs-function">(<span style="color:#00f">connection, room, messagePayload</span>) =&gt;</span> {
    chatRoom.broadcast({}, room, <span style="color:#219161">&#x27;I have entered the room: &#x27;</span> + connection.id)
  },
});</code></pre><p>If a <code>say</code> is blocked via an error thrown, the message will simply not be delivered to the client. If a <code>join</code> or <code>leave</code> is blocked, the verb or method used to invoke the call will be returned that error.</p><div><div id="Task Request Flow"><br/><h2 style="font-family:Roboto, sans-serif;font-weight:300;font-size:20px;line-height:1.5em;color:#3B5D72"><span style="font-weight:300;font-size:36px">Task Request Flow</span></h2><hr style="color:#E14E3A;background-color:#E14E3A;border:0;height:2px"/></div></div><p><img alt="/static/images/tutorials/connection_flow_tasks.png" src="/static/images/tutorials/connection_flow_tasks.png"/></p><div><div id="Task Middleware"><br/><h2 style="font-family:Roboto, sans-serif;font-weight:300;font-size:20px;line-height:1.5em;color:#3B5D72"><span style="font-weight:300;font-size:36px">Task Middleware</span></h2><hr style="color:#E14E3A;background-color:#E14E3A;border:0;height:2px"/></div></div><p>Task middleware is implemented as a thin wrapper around Node Resque plugins and currently exposes the <code>beforePerform</code>, <code>afterPerform</code>, <code>beforeEnqueue</code>, and <code>afterEnqueue</code> functions of Resque. Each middleware requires a <code>name</code> and at least one <code>function</code>. In addition, a middleware can be global, in which case it also requires a <code>priority</code>.</p><p>In the <code>preProcessor</code>, you can access the original task <code>params</code> through <code>this.args[0]</code>. In the <code>postProcessor</code>, you can access the task result at <code>this.worker.result</code>. In the <code>preEnqueue</code> and <code>postEnqueue</code> you can access the task <code>params</code> through <code>this.args[0]</code>. If you wish to prevent a task from being enqueued using the <code>preEnqueue</code> middleware you must explicitly set the <code>toRun</code> value to <code>false</code> in the callback. Because the task middleware is executed by Resque <code>this</code> is an instance of a Resque Worker and contains a number of other elements which may be useful in a middleware.</p><div><div id="Task Middleware Example"><br/><h2 style="font-family:Roboto, sans-serif;font-weight:300;font-size:20px;line-height:1.5em;color:#3B5D72"><span style="font-weight:300;font-size:36px">Task Middleware Example</span></h2><hr style="color:#E14E3A;background-color:#E14E3A;border:0;height:2px"/></div></div><p>The following example is a simplistic implementation of a task execution timer middleware.</p><pre style="display:block;overflow-x:auto;padding:0.5em;color:#000;background:#f8f8ff"><code><span style="color:#954121">import</span> {task, log, Initializer} <span style="color:#954121">from</span> <span style="color:#219161">&#x27;actionhero&#x27;</span>;

<span style="color:#954121">export</span> <span style="color:#954121">class</span> taskMiddleware <span style="color:#954121">extends</span> Initializer {
  <span style="color:#954121">constructor</span> (<span style="color:#00f"></span>) {
    <span style="color:#954121">super</span>()
    <span style="color:#954121">this</span>.name = <span style="color:#219161">&#x27;task middleware&#x27;</span>
  }

  initialize: <span class="hljs-function"><span style="color:#00f">()</span> =&gt;</span> {
    <span style="color:#954121">const</span> middleware = {
      name: <span style="color:#219161">&#x27;timer&#x27;</span>,
      global: <span style="color:#954121">true</span>,
      priority: <span style="color:#40a070">90</span>,

      preProcessor: <span style="color:#954121">async</span> <span class="hljs-function"><span style="color:#954121">function</span> (<span style="color:#00f"></span>) </span>{
        <span style="color:#954121">const</span> worker = <span style="color:#954121">this</span>.worker
        worker.startTime = process.hrtime()
      },

      postProcessor: <span style="color:#954121">async</span> <span class="hljs-function"><span style="color:#954121">function</span> (<span style="color:#00f"></span>) </span>{
        <span style="color:#954121">const</span> worker = <span style="color:#954121">this</span>.worker
        <span style="color:#954121">const</span> elapsed = process.hrtime(worker.startTime)
        <span style="color:#954121">const</span> seconds = elapsed[<span style="color:#40a070">0</span>]
        <span style="color:#954121">const</span> millis = elapsed[<span style="color:#40a070">1</span>] / <span style="color:#40a070">1000000</span>
        log(worker.job.class + <span style="color:#219161">&#x27; done in &#x27;</span> + seconds + <span style="color:#219161">&#x27; s and &#x27;</span> + millis + <span style="color:#219161">&#x27; ms.&#x27;</span>, <span style="color:#219161">&#x27;info&#x27;</span>)
      },

      preEnqueue: <span style="color:#954121">async</span> <span class="hljs-function"><span style="color:#954121">function</span> (<span style="color:#00f"></span>) </span>{
        <span style="color:#954121">const</span> arg = <span style="color:#954121">this</span>.args[<span style="color:#40a070">0</span>]
        <span style="color:#954121">return</span> <span style="color:#954121">true</span> <span style="color:#408080;font-style:italic">// returning `false` will prevent the task from enqueuing</span>
      },

      postEnqueue: <span style="color:#954121">async</span> <span class="hljs-function"><span style="color:#954121">function</span> (<span style="color:#00f"></span>) </span>{
        api.log(<span style="color:#219161">&quot;Task successfully enqueued!&quot;</span>)
      }
    }

    task.addMiddleware(middleware)
  }
}</code></pre></div><div class="hidden-xs hidden-sm col-md-3"><div style="height:0"><div style="padding-top:90px;position:sticky;top:0"><ul style="list-style-type:none;padding-left:0;margin-left:0"></ul></div></div></div></div><br/><div><a style="text-decoration:none" href="/tutorials"><button style="font-family:Roboto, sans-serif;font-weight:300;font-size:14px;max-width:200px;border-radius:50px;margin:0 auto;color:#FFFFFF;background-color:#E14E3A;border-color:#E14E3A;margin-top:20px;margin-bottom:20px;padding-top:15px;padding-bottom:15px;outline:none" type="button" class="btn btn-lg btn-default btn-block">Back to Tutorials</button></a></div></div><div class="hidden-xs hidden-sm col-md-3"></div></div></div><div style="background-color:#6E8898;color:#2F5266;font-weight:300;padding-top:100px;padding-bottom:100px"><div class="container"><div class="row"><div class="col-md-2"></div><div style="text-align:center;color:#FBF9E4;padding-bottom:100px" class="col-md-8"><h1 style="font-family:BebasNeue, Roboto, sans-serif;font-weight:bold;margin-top:20px;margin-bottom:10px;letter-spacing:2px;font-size:36px">Solutions</h1><h2 style="font-family:Roboto, sans-serif;font-weight:300;font-size:20px;line-height:1.5em;color:#3B5D72"><span style="color:#FBF9E4">Actionhero was built from the ground up to include all the features you expect from a modern API framework.</span></h2></div><div class="col-md-2"></div></div><div class="row"><div class="col-md-4"><div style="width:100%;padding-top:40px;padding-bottom:40px;padding-left:40px;padding-right:50px;background-color:#FBF9E4;box-shadow:0px 2px 4px #003C51"><div style="text-align:center;padding-bottom:10px"><h1 style="font-family:BebasNeue, Roboto, sans-serif;font-weight:bold;margin-top:20px;margin-bottom:10px;letter-spacing:2px;font-size:36px">Open Source</h1></div><hr style="color:#E14E3A;background-color:#E14E3A;border:0;height:2px"/><p>The Actionhero server is open source, under the Apache-2 license</p><hr style="color:#E14E3A;background-color:#E14E3A;border:0;height:2px"/><p>Actionhero runs on Linux, OS X, and Windows</p><hr style="color:#E14E3A;background-color:#E14E3A;border:0;height:2px"/><p>You always have access to the Actionhero team via<!-- --> <a href="/community">Slack and Github</a></p><br/><br/><div><a style="text-decoration:none" href="/downloads"><button style="font-family:Roboto, sans-serif;font-weight:300;font-size:14px;max-width:200px;border-radius:50px;margin:0 auto;color:#FFFFFF;background-color:#E14E3A;border-color:#E14E3A;margin-top:20px;margin-bottom:20px;padding-top:15px;padding-bottom:15px;outline:none" type="button" class="btn btn-lg btn-default btn-block">Download</button></a></div></div></div><div class="hidden-md hidden-lg hidden-xl col-md-4"><div style="width:100%;padding:20px;background-color:#2F5266;color:#FFFFFF;box-shadow:0px 2px 4px #003C51"><div style="text-align:center"><img src="/static/images/dog.svg"/><h1 style="font-family:BebasNeue, Roboto, sans-serif;font-weight:bold;margin-top:20px;margin-bottom:10px;letter-spacing:2px;font-size:36px"><span style="color:#FBF9E4">Premium Training &amp; Review</span></h1></div><hr style="color:#E14E3A;background-color:#E14E3A;border:0;height:2px"/><p>We provide support for corporate &amp; nonprofit customers starting at a flat rate of $150/hr. Our services include:</p><hr style="color:#E14E3A;background-color:#E14E3A;border:0;height:2px"/><ul><li><strong>Remote training for your team</strong></li><li><strong>Code Reviews</strong></li><li><strong>Best Practices Audits</strong></li><li><strong>Custom plugin &amp; Feature Development</strong></li></ul><hr style="color:#E14E3A;background-color:#E14E3A;border:0;height:2px"/><p>We have packages appropriate for all company sizes. Contact us to learn more.</p><br/><div><button style="font-family:Roboto, sans-serif;font-weight:300;font-size:14px;max-width:200px;border-radius:50px;margin:0 auto;color:#FFFFFF;background-color:#E14E3A;border-color:#E14E3A;margin-top:20px;margin-bottom:20px;padding-top:15px;padding-bottom:15px;outline:none" type="button" class="btn btn-lg btn-default btn-block">Contact Us</button></div></div></div><div class="hidden-xs hidden-sm col-md-4"><div style="width:125%;padding:40px;background-color:#2F5266;color:#FFFFFF;position:relative;top:-60px;box-shadow:0px 2px 4px #003C51;margin-left:-13%;margin-right:-5%;z-index:10"><div style="text-align:center;padding-bottom:10px"><img src="/static/images/dog.svg"/><h1 style="font-family:BebasNeue, Roboto, sans-serif;font-weight:bold;margin-top:20px;margin-bottom:10px;letter-spacing:2px;font-size:36px">Premium Training &amp; Review</h1></div><hr style="color:#E14E3A;background-color:#E14E3A;border:0;height:2px"/><p>We provide support for corporate &amp; nonprofit customers starting at a flat rate of $150/hr. Our services include:</p><hr style="color:#E14E3A;background-color:#E14E3A;border:0;height:2px"/><ul><li><strong>Remote training for your team</strong></li><li><strong>Code Reviews</strong></li><li><strong>Best Practices Workshops</strong></li><li><strong>Custom plugin &amp; Feature Development</strong></li></ul><hr style="color:#E14E3A;background-color:#E14E3A;border:0;height:2px"/><p>We have packages appropriate for all company sizes. Contact us to learn more.</p><br/><div><button style="font-family:Roboto, sans-serif;font-weight:300;font-size:14px;max-width:200px;border-radius:50px;margin:0 auto;color:#FFFFFF;background-color:#E14E3A;border-color:#E14E3A;margin-top:20px;margin-bottom:20px;padding-top:15px;padding-bottom:15px;outline:none" type="button" class="btn btn-lg btn-default btn-block">Contact Us</button></div></div></div><div class="col-md-4"><div style="width:100%;padding-top:40px;padding-bottom:40px;padding-right:40px;padding-left:50px;background-color:#FBF9E4;box-shadow:0px 2px 4px #003C51"><div style="text-align:center;padding-bottom:10px"><h1 style="font-family:BebasNeue, Roboto, sans-serif;font-weight:bold;margin-top:20px;margin-bottom:10px;letter-spacing:2px;font-size:36px">Enterprise</h1></div><hr style="color:#E14E3A;background-color:#E14E3A;border:0;height:2px"/><p>For larger customers in need of a support contract, we offer an enterprise plan including everything in the Premium plan plus:</p><hr style="color:#E14E3A;background-color:#E14E3A;border:0;height:2px"/><ul><li><strong>24/7 access to core members of the Actionhero Team</strong></li><li><strong>Emergency response packages</strong></li><li><strong>Deployment support</strong></li><li><strong>...and custom development against Actionhero’s core as needed.</strong></li></ul><br/><div><button style="font-family:Roboto, sans-serif;font-weight:300;font-size:14px;max-width:200px;border-radius:50px;margin:0 auto;color:#FFFFFF;background-color:#E14E3A;border-color:#E14E3A;margin-top:20px;margin-bottom:20px;padding-top:15px;padding-bottom:15px;outline:none" type="button" class="btn btn-lg btn-default btn-block">Contact Us</button></div></div></div></div></div></div></div><div style="padding-left:0;padding-right:0;font-family:Roboto, sans-serif;font-size:14px;font-weight:300" class="container-fluid"><footer id="footer-container" style="background-color:#2F5266;color:#FBF9E4;font-family:Roboto, sans-serif;font-weight:200"><div class="container"><div style="padding-bottom:50px;padding-top:50px;padding-left:100px" class="row"><div class="col-md-12"><img src="/static/images/actionhero-logo-header-wordmark.svg"/></div></div><div style="padding-bottom:100px" class="row"><div class="col-md-4"><div style="padding-left:100px"><p><a style="color:#FBF9E4" href="/terms">Terms</a></p><p>Contact us at<!-- --> <a style="color:#FBF9E4;font-weight:500" href="mailto:hello@actionherojs.com">hello@actionherojs.com</a></p><p>You can contribute to this website<!-- --> <a style="color:#FBF9E4;font-weight:500" href="https://github.com/actionhero/www.actionherojs.com" target="_blank">here</a>.</p><p><a href="https://medium.com/tag/actionherojs/latest" target="_new" style="color:#FBF9E4">Blogs</a></p><p style="color:#FFFFFF;font-weight:bold">© 2020<!-- --> <!-- -->Actionhero</p></div></div><div class="col-md-4"><div style="padding-left:100px"><p><a style="color:#FBF9E4" href="/why">Why Actionhero</a></p><p><a style="color:#FBF9E4" href="/get-started">Get Started</a></p><p><a href="https://docs.actionherojs.com" style="color:#FBF9E4">Documenation</a></p><p><a style="color:#FBF9E4" href="/solutions">Solutions</a></p><p><a style="color:#FBF9E4" href="/community">Community</a></p><p><a style="color:#FBF9E4" href="/downloads">Downloads</a></p></div></div><div class="col-md-4"><div style="padding-left:100px"><p><a href="https://www.npmjs.com/package/actionhero" target="_new" style="color:#FBF9E4">NPM</a></p><p><a href="https://twitter.com/actionherojs" target="_new" style="color:#FBF9E4">Twitter</a></p><p><a href="https://slack.actionherojs.com/" target="_new" style="color:#FBF9E4">Slack</a></p><p><a href="https://github.com/Actionhero/Actionhero" target="_new" style="color:#FBF9E4">Github</a></p><p><a href="https://actionherojs.threadless.com" target="_new" style="color:#FBF9E4">Shop</a></p></div></div></div></div></footer></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"markdown":"## Overview\n\nThere are 4 types of middleware in Actionhero:\n\n- **Action**\n- **Connection**\n- **Chat**\n- **Task**\n\nEach type of middleware is distinct from the others, and operates on distinct parts of a client's lifecycle. For a logical example, please inspect the following connection lifecycle:\n\n```bash\n\u003e Client **Connects**\n# connection middleware, \\`create\\` hook\n\n\u003e Client requests an **action**\n# action middleware, \\`preProcessor\\` hook\n# action middleware, \\`postProcessor\\` hook\n\n\u003e Client **joins a room**\n# chat middleware, \\`join\\` hook\n\n\u003e Client **says a message** in a room\n# chat middleware, \\`say\\` hook\n# chat middleware, \\`onSayReceive\\` hook\n\n\u003e Client requests a **disconnect** (quit)\n# chat middleware, \\`leave\\` hook\n# connection middleware, \\`destroy\\` hook\n\n\u003e Client executes a **task**\n# task middleware, \\`preProcessor\\` hook\n# task middleware, \\`postProcessor\\` hook\n```\n\n## Action Middleware\n\n![/static/images/tutorials/connection_flow_actions.png](/static/images/tutorials/connection_flow_actions.png)\n\n```ts\nimport { action } from \"actionhero\";\n\nconst middleware = {\n  name: \"userId checker\",\n  global: false,\n  priority: 1000,\n  preProcessor: data =\u003e {\n    if (!data.params.userId) {\n      throw new Error(\"All actions require a userId\");\n    }\n  },\n  postProcessor: data =\u003e {\n    if (data.thing.stuff == false) {\n      data.toRender = false;\n    }\n  }\n};\n\naction.addMiddleware(middleware);\n```\n\nactionhero provides hooks for you to execute custom code both before and after the execution of all or some actions. This is a great place to write authentication logic or custom loggers.\n\nAction middleware requires a `name` and at least one of `preProcessor` or `postProcessor`. Middleware can be `global`, or you can choose to apply each middleware to an action specifically via `action.middleware = []` in the action's definition. You supply a list of middleware names, like `action.middleware = ['userId checker']` in the example above.\n\nEach processor is passed `data`. Just like within actions, you can modify the `data` object to add to `data.response` to create a response to the client. If an error is thrown, the action will not execute, and `data.response.error` will contain the error. If a `preProcessor` has an error, the action will never be called.\n\nThe priority of a middleware orders it with all other middleware which might fire for an action. All global middleware happen before locally defined middleware on an action. Lower numbers happen first. If you do not provide a priority, the default from `api.config.general.defaultProcessorPriority` will be used.\n\n### The Data Object\n\n`data` contains the same information as would be passed to an action:\n\n```ts\ndata = {\n  connection: {},\n  action: \"randomNumber\",\n  toRender: true,\n  messageId: 1,\n  params: { action: \"randomNumber\", apiVersion: 1 },\n  actionStartTime: 1429531553417,\n  actionTemplate: {}, // the actual object action definition\n  response: {},\n  session: {}\n};\n```\n\nIf your middleware wants to pass information about the connection to the action, place that data within the `session` object. For example, you might have a middleware that sets `session.user` for use in your actions:\n\n```ts\nimport { action } from \"actionhero\";\nimport { Team, TeamMember } from \"./../models\"; // defined in your project\n\nconst authenticatedUserMiddleware = {\n  name: \"authenticated-team-member\",\n  global: false,\n  priority: 1000,\n  preProcessor: async data =\u003e {\n    const sessionData = await api.session.load(data.connection);\n    if (!sessionData) {\n      throw new Error(\"Please log in to continue\");\n    } else if (\n      !data.params.csrfToken ||\n      data.params.csrfToken !== sessionData.csrfToken\n    ) {\n      throw new Error(\"CSRF error\");\n    } else {\n      const teamMember = await TeamMember.findOne({\n        where: { guid: sessionData.guid },\n        include: Team\n      });\n      data.session = { data: sessionData, teamMember };\n    }\n  }\n};\n\naction.addMiddleware(authenticatedUserMiddleware);\n```\n\n## Connection Middleware\n\n```ts\nimport { log, connection } from \"actionhero\";\n\nconst connectionMiddleware = {\n  name: \"connection middleware\",\n  priority: 1000,\n  create: async connection =\u003e {\n    log(\"connection joined\");\n  },\n  destroy: async connection =\u003e {\n    log(\"connection left\");\n  }\n};\n\nconnection.addMiddleware(connectionMiddleware);\n```\n\nLike the action middleware above, you can also create middleware to react to the creation or destruction of all connections.\n\nKeep in mind that some connections persist (webSocket, socket) and some only exist for the duration of a single request (web). You will likely want to inspect `connection.type` in this middleware. Again, if you do not provide a priority, the default from `api.config.general.defaultMiddlewarePriority` will be used.\n\nAny modification made to the connection at this stage may happen either before or after an action, and may or may not persist to the connection depending on how the server is implemented.\n\n## Chat Middleware\n\n```ts\nimport { log, chatRoom, connection } from \"actionhero\";\n\nvar chatMiddleware = {\n  name: \"chat middleware\",\n  priority: 1000,\n  join: (connection, room) =\u003e {\n    // announce all connections entering a room\n    await chatRoom.broadcast(\n      {},\n      room,\n      \"I have joined the room: \" + connection.id\n    );\n  },\n  leave: (connection, room) =\u003e {\n    // announce all connections leaving a room\n    await chatRoom.broadcast(\n      {},\n      room,\n      \"I have left the room: \" + connection.id\n    );\n  },\n  /**\n   * Will be executed once per client connection before delivering the message.\n   */\n  say: (connection, room, messagePayload) =\u003e {\n    // do stuff\n    log(messagePayload);\n    messagePayload.cool = true;\n    return messagePayload;\n  },\n  /**\n   * Will be executed only once, when the message is sent to the server.\n   */\n  onSayReceive: function(connection, room, messagePayload) {\n    // do stuff\n    log(messagePayload);\n    messagePayload.receivedAt = new Date().getTime();\n    return messagePayload;\n  }\n};\n\nchatRoom.addMiddleware(chatMiddleware);\n```\n\nThe last type of middleware is used to act when a connection joins, leaves, or communicates within a chat room. We have 4 types of middleware for each step: `say`, `onSayReceive`, `join`, and `leave`.\n\nPriority is optional in all cases, but can be used to order your middleware. If an error is returned thrown any of these methods, it will be returned to the client, and the action/verb/message will not be sent.\n\nMore detail and nuance on chat middleware can be found in the [chat tutorial](tutorial-chat.html)\n\n### Chat Middleware Notes\n\n- In the example above, I want to announce the member joining the room, but he has not yet been added to the room, as the join logic is still firing. If the connection itself were to make the broadcast, it would fail because the connection is not in the room. Instead, an empty `{}` connection is used to proxy the message coming from the 'server'.\n- Only the `sayCallbacks` return `messagePayload`. This allows you to modify the message being sent to your clients.\n  - `messagePayload` will be modified and and passed on to all middleware inline, so you can append and modify it as you go\n- If you have a number of callbacks (`say`, `onSayReceive`, `join` or `leave`), the priority maters, and you can block subsequent methods from firing by throwing an error.\n- `sayCallbacks` are executed once per client connection. This makes it suitable for customizing the message based on the individual client.\n- `onSayReceiveCallbacks` are executed only once, when the message is sent to the server.\n\n```ts\nimport {chatRoom, connection} from 'actionhero';\n\n// in this example no one will be able to join any room, and the \\`say\\` middleware will never be invoked.\nchatRoom.addMiddleware({\n  name: 'blocking chat middleware',\n  join: (connection, room) =\u003e {\n    throw new Error('blocked from joining the room')\n  }),\n\n  say: (connection, room, messagePayload) =\u003e {\n    chatRoom.broadcast({}, room, 'I have entered the room: ' + connection.id)\n  },\n});\n```\n\nIf a `say` is blocked via an error thrown, the message will simply not be delivered to the client. If a `join` or `leave` is blocked, the verb or method used to invoke the call will be returned that error.\n\n## Task Request Flow\n\n![/static/images/tutorials/connection_flow_tasks.png](/static/images/tutorials/connection_flow_tasks.png)\n\n## Task Middleware\n\nTask middleware is implemented as a thin wrapper around Node Resque plugins and currently exposes the `beforePerform`, `afterPerform`, `beforeEnqueue`, and `afterEnqueue` functions of Resque. Each middleware requires a `name` and at least one `function`. In addition, a middleware can be global, in which case it also requires a `priority`.\n\nIn the `preProcessor`, you can access the original task `params` through `this.args[0]`. In the `postProcessor`, you can access the task result at `this.worker.result`. In the `preEnqueue` and `postEnqueue` you can access the task `params` through `this.args[0]`. If you wish to prevent a task from being enqueued using the `preEnqueue` middleware you must explicitly set the `toRun` value to `false` in the callback. Because the task middleware is executed by Resque `this` is an instance of a Resque Worker and contains a number of other elements which may be useful in a middleware.\n\n### Task Middleware Example\n\nThe following example is a simplistic implementation of a task execution timer middleware.\n\n```ts\nimport {task, log, Initializer} from 'actionhero';\n\nexport class taskMiddleware extends Initializer {\n  constructor () {\n    super()\n    this.name = 'task middleware'\n  }\n\n  initialize: () =\u003e {\n    const middleware = {\n      name: 'timer',\n      global: true,\n      priority: 90,\n\n      preProcessor: async function () {\n        const worker = this.worker\n        worker.startTime = process.hrtime()\n      },\n\n      postProcessor: async function () {\n        const worker = this.worker\n        const elapsed = process.hrtime(worker.startTime)\n        const seconds = elapsed[0]\n        const millis = elapsed[1] / 1000000\n        log(worker.job.class + ' done in ' + seconds + ' s and ' + millis + ' ms.', 'info')\n      },\n\n      preEnqueue: async function () {\n        const arg = this.args[0]\n        return true // returning `false` will prevent the task from enqueuing\n      },\n\n      postEnqueue: async function () {\n        api.log(\"Task successfully enqueued!\")\n      }\n    }\n\n    task.addMiddleware(middleware)\n  }\n}\n```\n","name":"middleware"}},"page":"/tutorials/[name]","query":{"name":"middleware"},"buildId":"aqoaiQGeKF7QCoiTT0lOb","nextExport":true,"isFallback":false}</script><script nomodule="" src="/_next/static/runtime/polyfills-724d884f9cbfd0f2db1d.js"></script><script async="" data-next-page="/tutorials/[name]" src="/_next/static/aqoaiQGeKF7QCoiTT0lOb/pages/tutorials/%5Bname%5D.js"></script><script async="" data-next-page="/_app" src="/_next/static/aqoaiQGeKF7QCoiTT0lOb/pages/_app.js"></script><script src="/_next/static/runtime/webpack-91b117697e716c22a78b.js" async=""></script><script src="/_next/static/chunks/framework.dbd31ae8fa0e794339d4.js" async=""></script><script src="/_next/static/chunks/commons.951ee3a86146f43ff3ef.js" async=""></script><script src="/_next/static/runtime/main-a439f05c489a40fb8abf.js" async=""></script><script src="/_next/static/chunks/e4d398197e5ec3535efaf346b243226a3bd3651f.df8ba5aacf2336156dd7.js" async=""></script><script src="/_next/static/chunks/f36d4fcc976e79064dae3de7ac516f908d662d29.fee39761db1fc475c2ba.js" async=""></script><script src="/_next/static/chunks/631952ed33728d5ceeac998142777c3b5b7644ad.f4cec1a1186f868c77e4.js" async=""></script><script src="/_next/static/aqoaiQGeKF7QCoiTT0lOb/_buildManifest.js" async=""></script></body></html>